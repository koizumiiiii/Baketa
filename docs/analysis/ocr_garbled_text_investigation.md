# OCR文字化け問題の包括調査レポート

## 🎯 問題概要

**症状**: OCR認識結果が文字化けする
- **期待**: `ゲームに戻る`, `設定`, `難易度`
- **実際**: `則醐山 三＝電護護 岬 話豊護 一間 -`

**発生タイミング**: Phase 13.2.2でPaddleOCR最適化パラメータを有効化した後

---

## 📊 調査経緯

### Phase 13.2.1-13.2.2: 閾値パラメータの修正
**修正内容**:
```csharp
// PaddleOcrEngineInitializer.cs:142
ApplyDetectionOptimization(_ocrEngine); // コメントアウト解除
```

**適用パラメータ**:
```csharp
var detectionParams = new Dictionary<string, object>
{
    { "det_db_thresh", 0.1f },           // 0.3 → 0.1 (検出閾値を下げて感度向上)
    { "det_db_box_thresh", 0.3f },       // 0.6 → 0.3 (小さい文字検出)
    { "det_db_unclip_ratio", 2.2f },     // デフォルト維持
    { "det_limit_side_len", 1440 },      // 960 → 1440 (解像度制限引き上げ)
    { "det_db_score_mode", "slow" },     // 精度優先
    { "det_limit_type", "max" }
};
```

**仮説A（当初）**: 閾値パラメータの調整で文字認識精度が向上するはず

---

### Phase 13.2.6: Option A画面変化検知によるOCRスキップ
**発見**: 最適化パラメータが適用されていない理由判明
- OCRがスキップされ、キャッシュされた古い結果を使用
- 初期化ログが一切出力されていない

**結論**: アプリ再起動と新規画面での翻訳実行が必要

---

### Phase 13.2.8-13.2.9: ユーザー指摘による仮説の再検証
**ユーザー指摘**:
> 「閾値によるものということ？そんなわけないだろ」

**認識**: 閾値だけで文字化けは発生しない。リサイズ処理が原因というのは**予想段階**。

---

### Phase 13.2.10: `_step >= minstep` エラーの発見と追跡

#### 🔥 決定的証拠

**ログエラー** (`baketa_debug.log:21:28:01.171`):
```
[21:28:01.171][T09] 🔍 [ROI_OCR] 領域OCRエラー - 座標=(0,0), エラー=OCR処理中にエラーが発生しました: _step >= minstep
```

**エラー連鎖**:
1. **1回目のOCR** (21:28:01): `_step >= minstep` エラーで失敗 → テキストなし
2. **2回目のOCR** (21:28:05): 成功したが文字化け `則町山 W 三＝電護護 話群護`

#### エラー発生箇所の追跡

| ファイル | 行番号 | 内容 |
|---------|--------|------|
| `OcrExecutionStageStrategy.cs` | 不明 | `🔍 [ROI_OCR] 領域OCRエラー` ログ出力 |
| `PaddleOcrEngine.cs` | 746 | `throw new OcrException($"OCR処理中にエラーが発生しました: {ex.Message}", ex);` |
| `PaddleOcrExecutor.cs` | 108 | `result = await ExecuteOcrInSeparateTaskAsync(processedMat, timeout, cancellationToken)` |
| `PaddleOcrExecutor.cs` | 338 | `var result = engine.Run(matForOcr);` ← **PaddleOCRネイティブ呼び出し** |

#### `_step >= minstep` の正体

**発見事実**:
- C#コード内にこのエラーメッセージは存在しない
- **PaddleOCRのネイティブライブラリ（C++/Python）内部で発生**
- OpenCVまたはPaddlePaddle内部の画像処理エラーの可能性

**Web検索結果** (OpenCV公式):
- `_step >= minstep` はOpenCVの`cv::Mat`リサイズ処理で発生
- 画像サイズ計算で不正な値が発生した場合のアサーション

---

## 🔍 根本原因の仮説

### 仮説1: `det_limit_side_len=1440` が大きすぎる ⭐⭐⭐⭐

**理由**:
- 入力画像サイズ: 3840x2160 (4K解像度)
- `det_limit_side_len=1440` に縮小しようとする
- 縮小率: 1440/3840 = 0.375 (約1/3)
- OpenCVのリサイズ処理で `_step >= minstep` 違反

**予想される問題**:
```
PaddleOCR内部処理:
1. 画像を det_limit_side_len に合わせてリサイズ
2. OpenCV cv::resize() 呼び出し
3. 縮小率が極端すぎて step 計算がおかしくなる
4. _step >= minstep アサーション失敗
5. 例外スロー
```

**検証方法**:
- `det_limit_side_len` を削除または960に戻す
- エラーが解消されるか確認

---

### 仮説2: 認識モデルの問題 ⭐⭐⭐

**根拠**:
- 2回目のOCR実行は成功している（エラーなし）
- しかし認識結果が文字化け: `則町山 W 三＝電護護`

**可能性**:
1. **モデルファイル破損**: PaddleOCR認識モデル（JapanV4）が破損
2. **言語設定ミス**: 日本語モデルではなく中国語モデルが使用されている
3. **エンコーディング問題**: UTF-8/Shift-JIS混在

**検証方法**:
- モデル選択ログの確認（現在は出力されていない）
- `PrepareModelsAsync` が実行されているか確認
- `LocalFullModels.JapanV4` が正しくロードされているか

---

### 仮説3: メモリ破損・スレッド競合 ⭐⭐

**根拠**:
- 1回目失敗、2回目成功（不安定動作）
- `_step >= minstep` はメモリアクセス違反の兆候

**可能性**:
- `Mat.Clone()` による並列処理で競合
- ArrayPool使用箇所でのメモリ管理ミス

**検証方法**:
- シングルスレッドモードで実行
- メモリプロファイリング

---

### 仮説4: Phase 5.2G ScaleImageWithLanczos の影響 ⭐⭐

**根拠**:
- 最近のコミット: `2e6380e revert: Phase 5.2C ScaleImageWithLanczos`
- 画像リサイズ処理に複数の変更履歴

**可能性**:
- Lanczosリサイズとdet_limit_side_lenの相互作用
- 二重リサイズによる画質劣化

**検証方法**:
- ScaleImageWithLanczos無効化テスト
- Phase 5.2G前のコミットでテスト

---

## 📋 検証すべき項目（優先順）

### P0: 即座に検証可能
1. ✅ `_step >= minstep` エラーの発生箇所特定（完了）
2. ⏳ `det_limit_side_len` を960に戻して再テスト
3. ⏳ モデル選択ログの追加と確認

### P1: 追加調査必要
4. ⏳ PaddleOCR内部のリサイズ処理コード確認
5. ⏳ 入力画像サイズと縮小率の関係分析
6. ⏳ JapanV4モデルの整合性確認

### P2: 詳細分析
7. ⏳ メモリプロファイリング
8. ⏳ スレッド競合チェック
9. ⏳ Lanczosリサイズ無効化テスト

---

## 🤔 Geminiへの質問事項

### 質問1: `_step >= minstep` エラーの解釈
OpenCVの `_step >= minstep` エラーが発生する一般的な原因は何ですか？
- 画像リサイズ処理での縮小率制限？
- メモリアライメント問題？
- Mat構造体の内部整合性違反？

### 質問2: det_limit_side_len の適切な値
PaddleOCR PP-OCRv5で4K解像度（3840x2160）の画像を処理する場合:
- `det_limit_side_len` の推奨値は？
- 1440は大きすぎる/小さすぎる？
- 解像度制限を設定しない場合のデフォルト動作は？

### 質問3: 文字化けの真の原因
1回目のOCR実行が `_step >= minstep` エラーで失敗し、2回目の実行が成功したが文字化けした場合:
- エラーリカバリー処理で不完全な画像データが渡された？
- 認識モデルが間違っている？
- エンコーディング問題？

### 質問4: 他の原因候補
閾値パラメータ（det_db_thresh, det_db_box_thresh）以外で、OCR認識結果を文字化けさせる可能性のある要因は何ですか？

### 質問5: 検証ストラテジー
この問題を確実に切り分けるための最も効率的な検証手順を提案してください。

---

## 📎 添付ログ証拠

### エラー発生タイミング
```
[21:28:01.112][T09] 🔍 [ROI_OCR] 領域OCR開始 - 座標=(0,0), サイズ=(3840x2160)
[21:28:01.171][T09] 🔍 [ROI_OCR] 領域OCRエラー - 座標=(0,0), エラー=OCR処理中にエラーが発生しました: _step >= minstep
[21:28:01.174][T09] 📝 [OCR_RESULT] 認識完了 - 処理時間: 3546ms
[21:28:01.176][T09] 📝 [OCR_RESULT] 検出テキスト: ''
```

### 2回目OCR（文字化け）
```
[21:28:05.871][T21] 🔍 [ROI_OCR] 領域OCR開始 - 座標=(0,0), サイズ=(3840x2160)
[21:28:06.954][T14] 🔍 [ROI_OCR] 領域OCR成功 - テキスト='則町山 W 三＝電護護 話群護 日山 旧田 華興 コ h 1', チャンク数=9
[21:28:06.956][T14] 📝 [OCR_RESULT] 認識完了 - 処理時間: 5003ms
```

---

## 🔄 次のアクション

1. **Geminiレビュー**: この資料をGeminiに共有し、専門的フィードバックを取得
2. **det_limit_side_len修正**: 1440 → 960または削除
3. **モデル選択ログ追加**: PrepareModelsAsync実行状況の可視化
4. **検証テスト実行**: アプリ再起動後の動作確認

---

**作成日時**: 2025-10-16
**調査者**: Claude Code (UltraThink方法論)
**ステータス**: 仮説検証段階、Geminiレビュー待ち
