# Phase 10.26: OCR検出不足問題 - UltraThink完全調査結果

## 🎯 問題概要

**ユーザー報告**: ゲーム一時停止メニューに8個のテキスト要素があるが、1個しか検出されない

**画面上のテキスト要素**:
1. "一時停止" (タイトル)
2. "ゲームに戻る" (青ボタン)
3. "設定" (青ボタン)
4. "タイトルに戻る" (青ボタン)
5. "ゲームを終了" (青ボタン)
6. "スタック離脱" (赤ボタン) + 説明文
7. "アンケート" (下部)
8. "お問い合わせ先 duckov@bilibili.com" (下部)

**実際の検出結果**:
- PaddleOCR検出: **2個**
- 座標復元後: **1個**
- 最終翻訳: **1個** (「ケート」のみ)

---

## 🔍 UltraThink調査プロセス

### Phase 1: 初期仮説 - 閾値問題？

**仮説**: DetectionThreshold=0.5 が厳しすぎる

**ユーザー反論**:
> 「検出されているのは'アンケート'の'ケート'部分だけだが閾値の問題ならアンケートも同様に除外されているはずです」

**結論**: 閾値だけでは説明できない。**部分検出**が起きている。

---

### Phase 2: ログ証拠分析

#### **PaddleOCR検出結果**

```
[16:58:00.524] ⚡ Regionsプロパティ発見: 件数=2
[16:58:00.524] ⚡ RotatedRect座標抽出成功:
  Center=(574.0, 1992.0), Size=(47.7x339.7), Angle=90.0°,
  Bounds={X=404,Y=1968,Width=340,Height=48}

[16:58:00.525] ⚡ RotatedRect座標抽出成功:
  Center=(866.0, 2094.0), Size=(58.7x1242.7), Angle=90.0°,
  Bounds={X=244,Y=2064,Width=1243,Height=59}
```

#### **座標復元結果**

```
[16:58:00.528] ✅ [K-28_STEP4] 座標復元完了: 検出=2個, 復元後有効=1個
```

**IsRegionValid()による除外**:
- 領域1: `Bounds={X=404,Y=1968,Width=340,Height=48}` → aspectRatio = **7.08** ✅ 通過
- 領域2: `Bounds={X=244,Y=2064,Width=1243,Height=59}` → aspectRatio = **21.07** ❌ 20.0超過で除外

---

### Phase 3: 入力画像サイズ分析

```
低解像度キャプチャ完了: 3840x2160 → 3840x2160 (スケール: 1)
検出専用タイムアウト: 6秒 (画像サイズ: 3840x2160)
```

**問題**: 4K解像度 (3840x2160) フル画像をPaddleOCRに直接入力

---

### Phase 4: 検出座標の位置分析

**検出された座標**:
- 領域1: Y=**1968px** (画面下部)
- 領域2: Y=**2064px** (画面最下部)

**画面構成推定** (4K: 3840x2160):
- タイトル「一時停止」: Y=**200-300px** 付近 ← **未検出**
- 青ボタン4個: Y=**500-1500px** 付近 ← **未検出**
- 赤ボタン「スタック離脱」: Y=**1600px** 付近 ← **未検出**
- 下部「アンケート」: Y=**1968px** ← **部分検出（「ケート」のみ）**
- 下部「お問い合わせ先」: Y=**2064px** ← **検出されたが除外**

---

## 🔥 発見された異常

### 異常1: Angle=90.0° (縦書きモード検出)

```
Size=(47.7x339.7), Angle=90.0°
```

**解釈**:
- 実際のサイズ: 幅339.7px、高さ47.7px
- PaddleOCRは90度回転として認識 → **縦書きテキスト検出モード？**

### 異常2: 画面上部のテキストが全く検出されない

**未検出領域**: Y=0-1900px (画面の88%が未検出)
**検出領域**: Y=1968-2160px (画面の9%のみ)

### 異常3: 部分検出 (「アンケート」→「ケート」)

**検出画像**: `after_crop_20251105_165800_778_340x48.png`
- 内容: 「ケート」のみ
- 元のテキスト: 「アンケート」(4文字)
- 検出された文字: 「ケート」(2文字) → **50%の文字が欠落**

---

## 💡 仮説: 根本原因候補

### 仮説A: PaddleOCR縦書きモード問題 ⭐⭐⭐

**根拠**: `Angle=90.0°`
**問題**: 横書きテキストが検出されない
**疑問**: なぜ「ケート」だけ検出されたのか？

### 仮説B: 4K解像度による小テキスト検出失敗 ⭐⭐⭐⭐

**根拠**: 3840x2160フル入力、小さなボタンテキストが検出されない
**問題**: DetectionThreshold=0.5では相対的に小さいテキストが除外
**疑問**: なぜ下部のテキストは検出されたのか？

### 仮説C: PaddleOCRモデルの問題 ⭐⭐⭐⭐⭐

**根拠**:
- 画面の特定領域（下部）のみ検出
- 部分的な文字検出（「アンケート」→「ケート」）
- 上部88%が完全に未検出

**可能性**:
1. **検出モデルが画像の特定領域のみをスキャンしている？**
2. **入力画像が内部で切り取られている？**
3. **前処理（スケーリング、正規化）で情報が失われている？**

### 仮説D: 入力画像自体の問題 ⭐⭐⭐⭐⭐

**疑問**:
- PaddleOCRに渡される画像は本当に3840x2160全体なのか？
- 前処理で画像が切り取られていないか？
- Phase 10.25のBGR24変換で何か問題が起きていないか？

---

## 🔬 Geminiレビュー依頼事項

### 質問1: 根本原因の優先度

以下の仮説の中で、最も可能性が高い根本原因はどれですか？

1. **PaddleOCR縦書きモード問題** (Angle=90.0°)
2. **4K解像度による小テキスト検出失敗**
3. **PaddleOCRモデルが画像の一部のみスキャン**
4. **入力画像の前処理問題**

### 質問2: 「部分検出」の説明

**「アンケート」→「ケート」の部分検出**をどう説明しますか？

- 閾値問題なら全体が除外されるはず
- なぜ後半2文字だけ検出されたのか？
- Angle=90.0°と関係があるか？

### 質問3: 検出座標の偏り

**なぜ画面下部9% (Y=1968-2160px) のみ検出されたのか？**

- PaddleOCRの内部動作に問題があるか？
- 入力画像が切り取られているか？
- スケーリング処理の問題か？

### 質問4: 調査方針

次に何を調査すべきですか？

- Option A: PaddleOCR入力直前の画像をデバッグ保存して確認
- Option B: PaddleOCRの検出パラメータ（Direction, Angle設定）を調査
- Option C: PaddleOCRモデルの内部動作をプロファイリング
- Option D: 画像前処理（ConvertToMatAsync, スケーリング）を詳細分析

### 質問5: Phase 10.25の影響

**Phase 10.25 (4チャンネル→BGR24変換) が影響している可能性はありますか？**

- Cv2.CvtColor(BGRA2BGR)で情報が失われた？
- Mat生成時のStride問題？

---

## 📋 調査済み項目

✅ CoordinateRestorer - 正常動作確認 (境界クリッピング対応済み)
✅ IsRegionValid() - アスペクト比20.0制限確認
✅ appsettings.json - DetectionThreshold=0.5, RecognitionThreshold=0.4
✅ PaddleOCR検出ログ - 2個の領域検出、Angle=90.0°確認
✅ 入力画像サイズ - 3840x2160 (4K) 確認

---

## 🎯 期待されるGeminiフィードバック

1. **真の根本原因の特定**
2. **部分検出メカニズムの説明**
3. **最優先で調査すべき項目**
4. **修正アプローチの推奨**

---

## 📊 ログ証拠ファイル

- `E:\dev\Baketa\Baketa.UI\bin\Debug\net8.0-windows10.0.19041.0\debug_app_logs.txt`
- `E:\dev\Baketa\Baketa.UI\bin\Debug\net8.0-windows10.0.19041.0\debug_images\after_crop_20251105_165800_778_340x48.png`
- ゲーム画面スクリーンショット (ユーザー提供)

---

## 🔧 現在の設定

**appsettings.json - PaddleOCR**:
```json
{
  "PaddleOCR": {
    "EnableHybridMode": true,
    "Language": "jpn",
    "DetectionThreshold": 0.5,
    "RecognitionThreshold": 0.4,
    "ModelName": "standard",
    "MaxDetections": 200,
    "UseGpu": true
  }
}
```

**AdaptiveTextRegionDetector - IsRegionValid()**:
```csharp
float aspectRatio = (float)rect.Width / rect.Height;
if (aspectRatio < 0.05f || aspectRatio > 20.0f)  // ← 20.0超過で除外
{
    return false;
}
```
