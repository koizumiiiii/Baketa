# Adaptive Tile Strategy Implementation Plan
## Issue #147 Phase 3: テキスト境界問題根本解決

### 背景と問題定義

#### 現状の課題
- **問題**: 2560x1080画像を3x2=6タイルに分割時、テキストがタイル境界で分断される
- **実例**: 「第一のスープ」がTile-3とTile-4境界で分割され翻訳品質劣化
- **根本原因**: 固定グリッド分割がテキスト境界を考慮しない

#### 解決目標
1. テキスト境界での分割を完全回避
2. OCR認識精度の向上
3. 翻訳品質の根本的改善
4. 既存アーキテクチャとの完全互換性維持

### 技術的解決策：ITileStrategy設計パターン

#### アーキテクチャ概要
```
OcrRegionGenerator → ITileStrategy → List<Rectangle> → BatchOcrProcessor
                  ↗ GridTileStrategy (既存互換)
                  ↘ AdaptiveTileStrategy (新実装)
```

#### 核心技術：PaddleOCR検出・認識分離活用
```csharp
// Phase 1: 検出のみ実行 (det=true, rec=false)
//   → 高速バウンディングボックス取得
// Phase 2: バウンディングボックス統合
//   → 意味のあるROI（Region of Interest）生成
// Phase 3: 統合ROIのみで認識処理 (rec=true)
//   → 背景処理完全排除、テキスト境界保護
```

### 実装方針

#### Phase 1: インターフェース設計・既存ロジック抽出 (1週間)
1. **ITileStrategy インターフェース定義**
2. **GridTileStrategy 実装** (既存BatchOcrProcessor抽出)
3. **OcrRegionGenerator 基盤クラス作成**
4. **既存テスト互換性確保**

#### Phase 2: AdaptiveTileStrategy プロトタイプ (2週間)
1. **PaddleOCR検出API統合**
2. **バウンディングボックス統合アルゴリズム実装**
3. **ROI生成ロジック開発**
4. **基本的な単体テスト作成**

#### Phase 3: 統合・最適化・検証 (1週間)
1. **BatchOcrProcessor統合**
2. **パフォーマンス最適化**
3. **包括的テスト実装**
4. **A/Bテスト機能追加**

#### Phase 4: 本格運用・監視 (1週間)
1. **設定による戦略切り替え機能**
2. **メトリクス・監視機能追加**
3. **最終的な品質検証**
4. **ドキュメント完成**

### 技術的詳細設計

#### バウンディングボックス統合アルゴリズム
```csharp
// 1. Pre-processing: ノイズ除去
//    - 小さすぎるボックス除去 (面積 < threshold)
//    - 信頼度低いボックス除去 (confidence < threshold)

// 2. Line Grouping: 行グループ分け
//    - Y座標オーバーラップ/近接度による行判定
//    - 行の高さ許容範囲内でのグループ化

// 3. Horizontal Merging: 水平方向結合
//    - 同一行内での水平距離閾値判定
//    - 包含矩形(Rectangle)生成による統合

// 4. Post-processing: 品質管理
//    - 極端に大きいROI分割検討
//    - ROIサイズ・アスペクト比検証
```

### メモリ・パフォーマンス最適化戦略

#### メモリ管理
- **`using`ステートメント徹底**: Image/Bitmap完全Dispose
- **パイプライン処理**: ROI処理を2-3個ずつバッチ化
- **メモリプール活用**: 既存`AdvancedImagePool`統合

#### パフォーマンス予測
- **追加コスト**: 初期テキスト検出 +100-200ms
- **削減コスト**: 背景領域処理排除 -30-50%
- **総合予測**: 現在比±10% (最適化効果による改善期待)

### 互換性・移行戦略

#### 既存システム互換性
- **BatchOcrProcessor**: インターフェース無変更
- **既存テスト**: 1,300+テストケース完全互換 (GridTileStrategy使用)
- **DI設定**: 設定による戦略選択機能

#### 段階的移行計画
1. **Phase 1**: GridTileStrategy (現行ロジック) デフォルト運用
2. **Phase 2**: AdaptiveTileStrategy A/Bテスト導入
3. **Phase 3**: 精度検証後、AdaptiveTileStrategy本格運用
4. **Phase 4**: GridTileStrategy保持 (フォールバック機能)

### リスク管理

#### 技術的リスク
- **PaddleOCR API依存**: 検出精度によるROI品質影響
- **統合アルゴリズム複雑性**: バウンディングボックス統合の調整困難
- **パフォーマンス劣化**: 初期検出処理による遅延

#### 対策
- **フォールバック機構**: GridTileStrategy常時利用可能
- **設定可能パラメータ**: 閾値・統合ロジック調整可能
- **段階的導入**: プロトタイプ→A/Bテスト→本格運用

### 成功指標・検証方法

#### 品質指標
- **テキスト境界分割回避率**: 95%以上 (「第一のスープ」問題解決)
- **OCR認識精度向上**: 現在比+10%以上
- **翻訳品質改善**: 意味のあるテキスト翻訳成功率+15%

#### パフォーマンス指標
- **処理時間**: 現在比+10%以内
- **メモリ使用量**: 現在比+20%以内
- **システム安定性**: 既存テスト100%パス維持

#### 検証方法
- **自動テスト**: ユニット・統合・パフォーマンステスト
- **実用テスト**: ゲーム翻訳での実証実験
- **A/Bテスト**: GridTileStrategy vs AdaptiveTileStrategy比較
- **メトリクス監視**: リアルタイム品質・パフォーマンス追跡

### 実装スケジュール

| フェーズ | 期間 | 主要成果物 | 検証方法 |
|---------|------|------------|----------|
| Phase 1 | 1週間 | ITileStrategy, GridTileStrategy | 既存テスト互換性 |
| Phase 2 | 2週間 | AdaptiveTileStrategy プロトタイプ | 単体テスト、基本機能検証 |
| Phase 3 | 1週間 | 統合・最適化完了 | 包括テスト、A/Bテスト |
| Phase 4 | 1週間 | 本格運用準備完了 | 最終品質検証 |

**総期間**: 5週間
**完了予定**: Issue #147 Phase 3完全完成

---

このドキュメントは、テキスト境界問題の根本解決を目指すIssue #147 Phase 3の包括的実装計画です。既存Baketaアーキテクチャとの完全互換性を保ちながら、OCR精度と翻訳品質の大幅向上を実現します。