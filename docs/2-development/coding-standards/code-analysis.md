# コード分析と警告対応ガイドライン

## 1. 概要

Baketaプロジェクトでは、コード品質を向上させるために静的コード分析を活用しています。このドキュメントでは、コード分析で検出される一般的な警告とその対応方法について説明します。

## 2. 主要なコード分析ルール

### 2.1 インターフェース設計 (CA1716, CA1711)

- **CA1716**: 予約キーワードと競合する名前を避ける
  - 特にインターフェースメソッドのパラメータ名として `event`, `object`, `string` などの予約語を使用しない
  - 代わりに `eventData`, `objectValue`, `textValue` などを使用する

- **CA1711**: 特定のサフィックスは避ける
  - 特殊な意味を持つサフィックス（例：Collection, Dictionary, EventArgs）は適切な場面でのみ使用する

### 2.2 メモリ/リソース管理 (CA2000, CA1805)

- **CA2000**: 破棄可能オブジェクトを明示的に破棄する
  - `using` ステートメントまたは `using` 宣言を使用する
  - 所有権を移譲する場合は明示的にドキュメント化する

- **CA1805**: 冗長な初期化を避ける
  - デフォルト値での明示的な初期化は避ける（例: `bool flag = false;` → `bool flag;`）
  - 特に意図的にデフォルト値を設定する場合を除く

### 2.3 コレクション処理 (CA1819, CA2227)

- **CA1819**: 配列プロパティを避ける
  - 配列の代わりに `IReadOnlyList<T>` や `IEnumerable<T>` を返す
  - 必要に応じて `.ToArray()` で明示的に変換する

- **CA2227**: 書き込み可能なコレクションプロパティを避ける
  - コレクションプロパティは読み取り専用にする（例: `IReadOnlyCollection<T>`）
  - 書き込み処理はメソッドを通して行う

### 2.4 パフォーマンス最適化 (CA1822, CA1848)

- **CA1822**: インスタンスデータを使用しないメソッドは `static` にする
  - 特に純粋関数や設定取得だけのメソッド

- **CA1848**: ロギングには `LoggerMessage` デリゲートを使用する
  - 文字列補間を避け、構造化ロギングを活用
  - ログメッセージをコンパイル時に生成し、実行時のオーバーヘッドを削減

### 2.5 例外処理 (CA1031, CA1062)

- **CA1031**: 一般的な例外のキャッチを避ける
  - 具体的な例外型を指定する
  - 例外を適切に処理または再スローする

- **CA1062**: `null` 引数のチェック
  - 外部から呼び出されるメソッドでは引数の `null` チェックを行う
  - `ArgumentNullException.ThrowIfNull` を活用する

### 2.6 API設計 (CA1024, CA1515, CA1852)

- **CA1024**: パラメータなしの `Get-` メソッドはプロパティに変換
  - 例: `GetCount()` → `Count { get; }`

- **CA1515**: アプリケーションAPIは内部型に
  - UI層などの外部公開不要なクラスは `internal` にする

- **CA1852**: 継承されないクラスは `sealed` に
  - 特に `internal` クラスは継承されることが少ないため

## 3. 対応方法

### 3.1 警告の抑制

警告を抑制すべきでない場合が多いですが、正当な理由がある場合は以下の方法で抑制できます：

```csharp
// 単一行の警告を抑制
#pragma warning disable CA1234
var example = "sample";
#pragma warning restore CA1234

// メソッドレベルでの抑制
[SuppressMessage("Category", "CA1234:説明", Justification = "抑制理由")]
public void SampleMethod() { }
```

### 3.2 プロジェクト全体の設定

`Directory.Build.props` ファイルでプロジェクト全体の分析設定を行うことができます：

```xml
<PropertyGroup>
  <AnalysisMode>All</AnalysisMode>
  <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
</PropertyGroup>
```

### 3.3 EditorConfig による設定

`.editorconfig` ファイルでより詳細な設定が可能です：

```
# CA1062: Null 引数チェック
dotnet_diagnostic.CA1062.severity = warning

# CA1303: ハードコードされた文字列を避ける
dotnet_diagnostic.CA1303.severity = suggestion
```

## 4. フィードバックプロセス

コード分析ルールに関するフィードバックや変更提案は、以下の手順で行ってください：

1. GitHub Issueで関連タグを付けて問題提起
2. メーリングリストまたはチームミーティングで議論
3. 合意に基づいてガイドラインを更新

## 5. チェックリスト

プルリクエスト提出前に以下の項目を確認してください：

- [ ] ビルド時に警告がないこと
- [ ] 抑制した警告がある場合、その理由が明確であること
- [ ] 新しく追加したクラスやメソッドが設計ガイドラインに準拠していること
- [ ] 変更内容に関連するテストが存在し、パスすること
