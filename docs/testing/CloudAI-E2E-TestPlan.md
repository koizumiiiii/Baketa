# Cloud AI翻訳 E2Eテスト手順書

Issue #78 Phase 6.3: エンドツーエンドテスト

## 概要

本手順書はCloud AI翻訳機能（Gemini/OpenAI）の手動E2Eテストを実施するためのガイドです。

---

## 前提条件

### 環境要件
- Windows 10/11 (x64)
- .NET 8.0 Runtime
- インターネット接続（Cloud API通信用）
- 有効なProプラン以上のライセンス

### 事前確認
- [ ] リレーサーバーがデプロイ済み（baketa-relay.xxx.workers.dev）
- [ ] GEMINI_API_KEY、OPENAI_API_KEYがシークレット登録済み
- [ ] アプリケーションがCloud AIモードで設定済み

---

## テストケース

### TC-001: 基本翻訳フロー（Gemini）

**目的:** Gemini APIを使用した基本的な画像翻訳が正常に動作することを確認

**手順:**
1. アプリケーションを起動
2. 翻訳対象のウィンドウ（英語テキスト含む）を選択
3. 「Start」ボタンをクリックしてLive翻訳を開始
4. 翻訳結果がオーバーレイとして表示されることを確認

**期待結果:**
- [ ] 翻訳結果がオーバーレイに日本語で表示される
- [ ] ステータスバーに「Gemini」使用中と表示される
- [ ] トークン使用量がインクリメントされる

---

### TC-002: フォールバック動作（Gemini→OpenAI）

**目的:** Geminiが失敗した場合、OpenAIにフォールバックすることを確認

**手順:**
1. Cloudflare Dashboardで一時的にGEMINI_API_KEYを無効化（削除）
2. アプリケーションで翻訳を実行
3. フォールバック動作を確認
4. GEMINI_API_KEYを復元

**期待結果:**
- [ ] Primary（Gemini）失敗後、Secondary（OpenAI）に自動フォールバック
- [ ] 翻訳が正常に完了する
- [ ] ログに「Fallback to secondary」が記録される

---

### TC-003: トークン使用量表示

**目的:** トークン使用量が正しく表示・更新されることを確認

**手順:**
1. アプリケーションを起動
2. 設定画面 → ライセンス設定を開く
3. 月間使用量を確認
4. 翻訳を3回実行
5. 使用量が増加していることを確認

**期待結果:**
- [ ] 使用量が数値で表示される（例: 1,500 / 4,000,000 tokens）
- [ ] 翻訳実行後に使用量が増加する
- [ ] プログレスバーが正確に反映される

---

### TC-004: 80%警告通知

**目的:** 月間使用量が80%に達した際に警告通知が表示されることを確認

**手順:**
1. テスト用に低いトークン上限を設定（または使用量を人工的に増加）
2. 80%相当のトークンを消費する翻訳を実行
3. トースト通知を確認

**期待結果:**
- [ ] 黄色の警告トースト通知が表示される
- [ ] 「月間上限の80%に到達しました」メッセージ
- [ ] 残りトークン数が表示される

---

### TC-005: 90%警告通知

**目的:** 月間使用量が90%に達した際にクリティカル警告が表示されることを確認

**手順:**
1. 90%相当のトークンを消費する翻訳を実行
2. トースト通知を確認

**期待結果:**
- [ ] オレンジ色の警告トースト通知が表示される
- [ ] 「月間上限の90%に到達しました」メッセージ
- [ ] 残りトークン数が表示される

---

### TC-006: 100%上限到達

**目的:** 月間使用量が100%に達した際にCloud AI翻訳が制限されることを確認

**手順:**
1. 100%相当のトークンを消費
2. 追加翻訳を試行
3. 動作を確認

**期待結果:**
- [ ] 赤色のエラートースト通知が表示される
- [ ] 「月間上限に達しました」メッセージ
- [ ] ローカル翻訳へのフォールバック、または翻訳拒否

---

### TC-007: ネットワークエラー時の動作

**目的:** ネットワーク切断時の適切なエラーハンドリングを確認

**手順:**
1. アプリケーションを起動しLive翻訳を開始
2. ネットワーク接続を一時的に切断
3. 翻訳を試行
4. ネットワークを復元

**期待結果:**
- [ ] ネットワークエラーの通知が表示される
- [ ] ローカル翻訳へのフォールバック（設定による）
- [ ] ネットワーク復元後、Cloud AI翻訳が再開される

---

### TC-008: レート制限時の動作

**目的:** APIレート制限に達した場合の適切な動作を確認

**手順:**
1. 短時間に大量の翻訳リクエストを送信
2. レート制限エラー発生を確認
3. 待機後に復帰することを確認

**期待結果:**
- [ ] レート制限通知が表示される
- [ ] 一時的に翻訳が停止される
- [ ] 指数バックオフ後に自動復帰

---

### TC-009: シングルショット翻訳

**目的:** 単発翻訳モードが正常に動作することを確認

**手順:**
1. 「Shot」ボタンをクリック
2. 翻訳結果を確認
3. 再度「Shot」ボタンをクリックしてオーバーレイをクリア
4. 再度「Shot」ボタンをクリックして新規翻訳

**期待結果:**
- [ ] 単発翻訳が実行される
- [ ] オーバーレイが表示される
- [ ] 2回目のクリックでオーバーレイがクリアされる
- [ ] 3回目のクリックで新規翻訳が実行される

---

### TC-010: 長文テキスト翻訳

**目的:** 長文テキストの翻訳精度と処理時間を確認

**手順:**
1. 大量のテキストを含む画面をキャプチャ
2. 翻訳を実行
3. 処理時間と結果を確認

**期待結果:**
- [ ] 翻訳が完了する（タイムアウトしない）
- [ ] 翻訳結果が妥当である
- [ ] 処理時間が許容範囲内（< 10秒）

---

## パフォーマンス基準

| 項目 | 基準値 | 測定方法 |
|------|--------|----------|
| 翻訳レイテンシ | < 3秒 | 翻訳開始からオーバーレイ表示まで |
| メモリ使用量 | < 500MB | 10回翻訳後のワーキングセット |
| CPU使用率 | < 30% | 翻訳実行中の平均 |
| フォールバック時間 | < 5秒 | Primary失敗からSecondary成功まで |

---

## トラブルシューティング

### Q: 翻訳が実行されない
- [ ] リレーサーバーのヘルスチェックを確認
- [ ] APIキーが正しく設定されているか確認
- [ ] ネットワーク接続を確認

### Q: トークン使用量が更新されない
- [ ] ライセンスの有効期限を確認
- [ ] セッションを再認証

### Q: フォールバックが発生しない
- [ ] 両方のAPIキーが設定されているか確認
- [ ] エンジンステータスを確認

---

## テスト結果記録

| テストケース | 実施日 | 実施者 | 結果 | 備考 |
|-------------|--------|--------|------|------|
| TC-001 | | | | |
| TC-002 | | | | |
| TC-003 | | | | |
| TC-004 | | | | |
| TC-005 | | | | |
| TC-006 | | | | |
| TC-007 | | | | |
| TC-008 | | | | |
| TC-009 | | | | |
| TC-010 | | | | |
