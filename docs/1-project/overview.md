# Baketaプロジェクト概要

*最終更新: 2025年6月5日*

> **プロダクション状態**: Baketa翻訳システムは**Phase 5完全実装達成**により、プロダクション環境での運用が可能な状態です。実ファイル検証により品質が確認され、翻訳エンジン状態監視機能からUI統合まですべて完成しています。

## 1. プロジェクト概要

Baketaは、ゲームプレイ中にリアルタイムでテキストを翻訳するWindows専用オーバーレイアプリケーションです。ゲーム画面上のテキストをOCR技術で検出し、翻訳結果を透過オーバーレイとして表示します。

> **注意**: Baketaプロジェクトは現在、Windows専用アプリケーションとして開発されています。内部設計ではプラットフォーム抽象化レイヤーを採用していますが、現時点ではWindows対応のみを実装し、他プラットフォームへの対応予定はありません。OCR最適化にはOpenCVを使用します。

### 1.1 主要機能

#### **🔍 OCR・画像処理システム**
- **OCR処理**: ゲーム画面からのテキスト検出（PaddleOCR）
- **OpenCVベース最適化**: 画像前処理と精度向上
- **差分検出**: 画面変更の高精度検出によるパフォーマンス最適化

#### **🌐 多言語翻訳システム（プロダクション運用中）**
- **SentencePiece統合**: Microsoft.ML.Tokenizers v0.21.0による高精度トークン化とOPUS-MTモデルの完全互換性
- **ハイブリッド翻訳**: ローカル（OPUS-MT）とクラウド（Gemini API）のフォールバック対応
- **中国語翻訳システム**: 簡体字・繁体字・双方向翻訳完全実装、自動文字体系検出
- **8言語ペア完全対応**: ja⇔en⇔zhの完全相互翻訳（9個OPUS-MTモデル、総容量4.0MB）
- **2段階翻訳戦略**: ja→en→zh経由の高品質翻訳

#### **🔍 翻訳エンジン状態監視機能（新実装）**
- **リアルタイム状態監視**: LocalOnly/CloudOnly/Networkの3系統完全監視
- **フォールバック記録機能**: レート制限・ネットワークエラー時の自動切り替え記録
- **ヘルスチェック機能**: モデルファイル・メモリ・ API接続の包括的確認

#### **🎨 UIシステム（完全実装済み）**
- **オーバーレイ表示**: 透過的なUI、クリックスルー対応
- **統合設定管理**: エクスポート・インポート・自動保存・妥当性検証完全実装
- **通知システム**: WindowNotificationManager統合・確認ダイアログ実装
- **ゲームプロファイル**: ゲーム別の最適設定

### 1.2 差別化要素（プロダクション達成済み）

#### **🏆 翻訳システムの先進性**
- **SentencePiece完全統合**: OPUS-MTモデルとの完全互換性と高精度トークン化（Microsoft.ML.Tokenizers v0.21.0）
- **ハイブリッド翻訳エンジン**: ローカル（高速・無料）とクラウド（高品質・有料）のインテリジェントフォールバック
- **東アジア8言語ペア完全対応**: 日本語⇔英語⇔中国語の完全相互翻訳（世界初の2段階翻訳戦略実装）
- **中国語特化システム**: 簡体字・繁体字自動検出、プレフィックス自動付与、変種別並行翻訳

#### **🔍 高度なシステム監視機能**
- **リアルタイム状態監視**: 翻訳エンジン状態、ネットワーク接続、フォールバック状況の3系統監視
- **インテリジェントフォールバック**: レート制限・ネットワークエラー時の自動切り替えと詳細ログ記録
- **包括的ヘルスチェック**: モデルファイル存在確認、メモリ使用量監視、API接続状態確認

#### **🎨 ユーザーエクスペリエンスの卓越性**
- **高度な設定管理**: エクスポート・インポート・自動保存・妥当性検証の完全自動化
- **直感的通知システム**: WindowNotificationManager統合、確認ダイアログ、適切なユーザーフィードバック
- **高カスタマイズ性**: オーバーレイの表示位置や見た目を詳細に調整可能

#### **⚡ パフォーマンスと品質**
- **OpenCVによるOCR最適化**: 各ゲームに最適なOCR設定を調整
- **高度な差分検出**: 画面変更を高精度で検出し、不要な処理をスキップ
- **低リソース消費**: ゲームパフォーマンスへの影響を最小限に抑えた設計（< 50ms/text）
- **プロダクション品質**: CA警告0件、C# 12最新構文、240テスト100%成功率

## 2. アーキテクチャ

Baketaプロジェクトは5つの主要レイヤーから構成されるクリーンアーキテクチャを採用します：

```
Baketa/
├── Baketa.Core/               # コア機能と抽象化
│   ├── Common/                # 共通ユーティリティ
│   ├── Abstractions/          # インターフェース
│   │   ├── Imaging/           # 画像抽象化インターフェース
│   │   └── Platform/          # プラットフォーム抽象化インターフェース
│   ├── Models/                # モデルクラス
│   └── Translation/           # 翻訳関連機能
│       └── Models/            # 翻訳モデル
│
├── Baketa.Infrastructure/     # インフラストラクチャ層
│   ├── OCR/                   # OCR機能実装
│   ├── Translation/           # 翻訳機能実装
│   │   ├── Cloud/             # クラウド翻訳（Gemini API）
│   │   ├── Local/             # ローカル翻訳（OPUS-MT）
│   │   │   └── Onnx/          # ONNX推論エンジン
│   │   │       ├── SentencePiece/  # SentencePiece統合
│   │   │       └── Chinese/   # 中国語翻訳特化
│   │   ├── Hybrid/            # フォールバック翻訳エンジン
│   │   ├── Complete/          # 統合翻訳システム
│   │   ├── Extensions/        # DI拡張メソッド
│   │   └── Services/          # 翻訳サポートサービス
│   └── Services/              # その他サービス実装
│
├── Baketa.Infrastructure.Platform/  # プラットフォーム依存機能
│   ├── Abstractions/          # プラットフォーム抽象化インターフェース
│   ├── Windows/               # Windows実装
│   │   └── NativeMethods/     # P/Invoke定義
│   └── Adapters/              # アダプターレイヤー
│
├── Baketa.Application/        # アプリケーション層 
│   ├── Services/              # アプリケーションサービス
│   ├── DI/                    # 依存性注入管理
│   └── Events/                # イベント処理
│
├── Baketa.UI/                 # UI層
│   ├── Avalonia/              # Avalonia UI実装
│   │   ├── ViewModels/        # MVVMビューモデル
│   │   ├── Views/             # XAMLビュー
│   │   ├── Controls/          # カスタムコントロール
│   │   └── Services/          # UIサービス
│   └── Abstractions/          # UI抽象化
```

### 2.1 Baketa.Core

プラットフォーム非依存のコア機能と抽象化を提供します：

- 基本的なインターフェースと抽象化
- データモデル
- イベント集約機構
- 共通ユーティリティ
- 翻訳関連モデル（Baketa.Core.Translation.Models）

### 2.2 Baketa.Infrastructure

プラットフォーム非依存のインフラストラクチャサービスを提供します：

- **OCRエンジン**: PaddleOCRとOpenCV最適化
- **翻訳システム**:
  - **ローカル翻訳**: OPUS-MT ONNXモデル + SentencePieceトークナイザー
  - **クラウド翻訳**: Google Gemini API 統合
  - **フォールバック翻訳**: ローカル/クラウドのフォールバック対応
  - **中国語特化**: 簡体字・繁体字・双方向翻訳完全対応
- **永続化機能**: モデルキャッシュ、翻訳キャッシュ
- **共通サービス実装**: レート制限、メトリクス管理

### 2.3 Baketa.Infrastructure.Platform

Windows固有の実装を担当します：

- プラットフォーム抽象化インターフェース
- Windows固有のプラットフォームサービス
- 画面キャプチャ実装
- 画像処理最適化（OpenCV）
- システムトレイとホットキー
- プラットフォーム依存機能のアダプター
- P/Invoke定義（Windows API呼び出し）

### 2.4 Baketa.Application

ビジネスロジックと機能統合を担当します：

- アプリケーションサービス
- 依存性注入管理
- イベントハンドラー
- 設定管理

### 2.5 Baketa.UI

ユーザーインターフェースとプレゼンテーションロジックを担当します：

- Avalonia UI実装
- ビューモデル
- UI固有サービス
- カスタムコントロール

## 3. 技術スタック

### 3.1 基本構成

- **フレームワーク**: .NET 8 (LTS)
- **UI技術**: Avalonia UI（ReactiveUI）
- **アーキテクチャ**: MVVMパターン
- **OCRエンジン**: PaddleOCR + OpenCV最適化
- **翻訳システム**:
  - **ローカル**: OPUS-MT ONNXモデル + Microsoft.ML.Tokenizers v0.21.0
  - **クラウド**: Google Gemini API
  - **フォールバック**: レート制限・ネットワークエラー時のフォールバック

### 3.2 特化翻訳機能（プロダクション運用中）

#### **🎆 SentencePiece統合システム（完全実装済み）**
- **Microsoft.ML.Tokenizers v0.21.0完全統合**: 9個OPUS-MTモデルとの完全互換性（総容量4.0MB）
- **高精度トークン化**: モデル特性に合わせた最適化トークン化処理
- **自動モデル管理**: ダウンロード、キャッシュ、バージョン管理、自動クリーンアップ
- **240テスト100%成功**: 包括的テストカバレッジで品質保証

#### **🌏 中国語翻訳システム（世界初の完全実装）**
- **3種類の中国語変種完全対応**:
  - 簡体字（中国本土、`>>cmn_Hans<<`）
  - 繁体字（台湾・香港、`>>cmn_Hant<<`）
  - 自動判定（コンテキストベース）
- **高度な自動機能**:
  - 文字体系自動検出アルゴリズム
  - OPUS-MTプレフィックス自動付与システム
  - 変種別並行翻訳機能
- **完全双方向翻訳**: zh⇔ja、zh⇔enの直接翻訳とja⇔zhの2段階翻訳

#### **🚀 双方向翻訳戦略（世界初の2段階翻訳）**
- **直接翻訳モード**: 
  - ja⇔en（日英相互翻訳）
  - zh⇔en（中英相互翻訳）
  - zh→ja（中日直接翻訳）
- **2段階翻訳モード**: 
  - ja→en→zh（日本語→英語→中国語）
  - 高品質翻訳のための中継言語アプローチ
  - 自動品質判定と戦略選択

#### **🔍 インテリジェントフォールバック戦略（新実装）**
- **リアルタイム状態監視**: LocalOnly/CloudOnly/Networkの3系統完全監視
- **自動フォールバック機能**:
  - レート制限時: CloudOnly → LocalOnly自動切り替え
  - ネットワークエラー時: オフラインモード自動遷移
  - APIエラー時: ローカル翻訳フォールバック
- **詳細ログ記録**: フォールバック理由、状態変更履歴、パフォーマンスメトリクス

### 3.3 Windows固有技術

- **プラットフォーム抽象化**: 内部的に抽象化レイヤーを使用するが、現在はWindows実装のみ
- **Windows実装**:
  - 画面キャプチャ: Windows GDI, Direct3D
  - オーバーレイ: Windows層化ウィンドウ（WS_EX_LAYERED）
  - システムトレイ: Windows通知領域API
  - ホットキー: Windows RegisterHotKey API

## 4. イメージ処理アプローチ

Baketaは特にOCR機能を強化するために、下記の画像処理アプローチを採用します：

### 4.1 画像前処理パイプライン

1. **キャプチャ**: 画面または領域のキャプチャ
2. **グレースケール変換**: カラー→グレースケール変換
3. **ノイズ除去**: ガウシアンフィルタなどによるノイズ除去
4. **コントラスト強調**: ヒストグラム均一化
5. **二値化**: 適応的閾値処理
6. **モルフォロジー演算**: 膨張・収縮による文字形状の整形
7. **テキスト領域検出**: MSERまたはエッジベースの検出
8. **ゲーム特性に基づく調整**: ゲームプロファイル設定の適用

### 4.2 差分検出の最適化

ゲームのパフォーマンスを低下させないよう、差分検出を最適化：

- サンプリングベースの高速検出
- テキスト領域に焦点を当てた変化検出
- ヒストグラム分析による効率的な差分識別

### 4.3 プロファイルベース最適化

プロファイルに基づく画像処理パラメータの最適化：

- ゲームごとの専用プロファイル
- 自動パラメータチューニング
- 結果フィードバックによる継続的改善

## 5. プラットフォーム抽象化レイヤーの役割

Baketaプロジェクトは、内部設計として抽象化レイヤーを採用していますが、現時点ではWindows専用アプリケーションとして実装されています：

### 5.1 設計原則

1. **コードの整理**: 関心事の分離によるコード整理とメンテナンス性向上
2. **テスト容易性**: モック可能なインターフェースを通じてテスト容易性を向上
3. **明示的な依存性**: ネイティブAPI呼び出しを明確に分離
4. **コード品質向上**: 明確な責任分離によるコード品質の向上

### 5.2 主要インターフェース

以下のWindows機能へのアクセスを抽象化インターフェースを通して提供:

- **IWindowManager**: Windows ウィンドウ管理機能
- **IScreenCapturer**: 画面キャプチャ機能
- **IKeyboardHook**: キーボードフック機能
- **IImage**: Windows画像表現の抽象化

## 6. 開発ガイドライン

### 6.1 命名規則

- **名前空間**: Baketa.{レイヤー}.{機能領域}
- **インターフェース**: I{名前}
- **抽象クラス**: {名前}Base
- **実装クラス**: {機能}{タイプ}（例: OpenCvImageProcessor）
- **ファイル名**: クラス名と一致させる

### 6.2 コード編成

- 関心の分離を厳格に守る
- 一つのクラスは一つの責任のみを持つ
- サービス間の依存は常にインターフェースを通じて行う
- ビジネスロジックとプラットフォーム固有コードを分離する

### 6.3 ドキュメント

- パブリックAPIには常にXMLドキュメントコメントを付ける
- アーキテクチャの決定は文書化する
- コンポーネント間の連携は図表を含めて説明する

## 7. 実装計画

1. **基盤実装**
   - クリーンアーキテクチャの基盤を構築
   - 名前空間構造の整理
   - 基本インターフェースの定義

2. **コア機能の実装**
   - イメージ抽象化レイヤーの実装
   - OCRシステムの連携
   - 翻訳システムの統合

3. **UI実装**
   - Avalonia UIフレームワークの実装
   - メインウィンドウとオーバーレイ実装
   - 設定UIの実装

4. **配布と運用**
   - インストーラー作成
   - 更新システム構築
   - エラー報告・診断システム

## 8. 最近の改善点（プロダクションリリース達成）

### 8.1 名前空間統一プロジェクト（2025年5月完了）

翻訳関連のデータモデルが以下の2つの名前空間に分散していた問題を解決：

- `Baketa.Core.Models.Translation` (旧)
- `Baketa.Core.Translation.Models` (新・統一)

主な改善点：
- すべての翻訳関連モデルを `Baketa.Core.Translation.Models` に統一
- 名前空間の衝突と型の曖昧参照を排除
- 言語コードの表現を国際標準（ISO 639-1/ISO 3166）に準拠（例: `zh-CN`形式）
- 整理された命名規則とクラス設計

詳細は[名前空間統一完了報告](../development-notes/namespace-unification-completion-report.md)を参照してください。

### 8.2 SentencePiece統合・中国語翻訳システム完成（2025年5月完了）

**Microsoft.ML.Tokenizers v0.21.0** を活用したSentencePiece統合と、東アジア3言語の完全相互翻訳システムを実現：

**主な実装成果**：
- **6個のOPUS-MTモデル配置完了**: 総容4.0MB、東アジア8言語ペア完全対応
- **240個のテスト全成功**: SentencePiece 178個 + 中国語翻訳 62個
- **中国語翻訳システム**: 簡体字・繁体字・自動検出完全実装
- **2段階翻訳戦略**: ja→en→zh 経由の高品質翻訳
- **パフォーマンス最適化**: < 50ms/テキスト、> 50 tasks/sec

**サポート言語ペア** (完全双方向)：
- ja↔en (直接翻訳)
- zh↔en (直接翻訳)
- zh→ja (直接翻訳)
- ja→zh (2段階翻訳)

**中国語特化機能**：
- 簡体字・繁体字のユーザー選択式対応
- OPUS-MTプレフィックス自動付与 (`>>cmn_Hans<<`, `>>cmn_Hant<<`)
- 文字体系自動検出機能
- 変種別並行翻訳機能

### 8.3 Gemini API統合・翻訳戦略簡素化（2025年5月完了）

**Google Gemini API** との統合、および翻訳戦略の5戦略から2戦略への簡素化を実現：

**主な実装成果**：
- **Google Gemini API完全統合**: 高品質クラウド翻訳の実現
- **フォールバック翻訳エンジン**: レート制限・エラー時のフォールバック対応
- **翻訳戦略簡素化**: 5戦略から2戦略への削減 (60%削減)
- **コスト最適化機能**: レート制限・キャッシュシステム

**簡素化された翻訳戦略**：
- **LocalOnly**: OPUS-MTのみ使用 (高速・無料・オフライン対応)
- **CloudOnly**: Gemini APIのみ使用 (高品質・有料・ネットワーク必須)

**フォールバック機能**：
- レート制限時の自動ローカル翻訳切り替え
- ネットワークエラー時のローカル翻訳フォールバック
- ユーザーによる手動エンジン選択機能

### 8.4 翻訳エンジン状態監視機能実装（2025年6月完成）

**Phase 5の翻訳エンジン状態監視機能**が完全に実装され、プロダクション品質に到達しました。

**主な実装成果**：
- **TranslationEngineStatusService (568行)**: 本格的な状態監視システム実装
- **3系統完全監視**: LocalOnlyエンジン、CloudOnlyエンジン、ネットワーク接続状態
- **リアルタイム状態更新**: Observableパターンによるイベントシステム
- **フォールバック記録機能**: 自動切り替え発生時の詳細記録
- **定期監視タイマー**: 30秒間隔での自動監視

### 8.5 UI統合システム完全実装（2025年6月完成）

**プロダクションレベルのUI統合システム**が完全に実装され、実ファイル検証によって品質が確認されました。

**主な実装成果**：
- **TranslationSettingsViewModel (725行)**: 統合設定管理ViewModel完全実装
- **SettingsFileManager (527行)**: 完全永続化システム実装
- **通知システム**: WindowNotificationManager統合・確認ダイアログ実装
- **設定管理**: エクスポート・インポート・自動保存・妥当性検証完全実装
- **15個UIコンポーネント**: Settings専用UI + 統合ViewModel完全実装

### 8.6 コード品質向上とプロダクション準備完了（2025年6月達成）

**プロダクション品質基準を満たすコード品質**が達成され、リリース準備が完了しました。

**品質指標達成**：
- **CA警告0件**: 全コード分析警告の完全解消
- **C# 12最新構文**: コレクション初期化、when句パターンマッチング等採用
- **240テスト100%成功率**: SentencePiece + Chinese + Integrationテスト
- **実ファイル検証完了**: プロジェクト内実ファイル直接調査で品質確認
- **プロダクションリリース準備完了**: 100%実装確認完了