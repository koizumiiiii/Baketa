# Baketaプロジェクト概要

*最終更新: 2025年5月18日*

## 1. プロジェクト概要

Baketaは、ゲームプレイ中にリアルタイムでテキストを翻訳するWindows専用オーバーレイアプリケーションです。ゲーム画面上のテキストをOCR技術で検出し、翻訳結果を透過オーバーレイとして表示します。

> **注意**: Baketaプロジェクトは現在、Windows専用アプリケーションとして開発されています。内部設計ではプラットフォーム抽象化レイヤーを採用していますが、現時点ではWindows対応のみを実装し、他プラットフォームへの対応予定はありません。OCR最適化にはOpenCVを使用します。

### 1.1 主要機能

- **OCR処理**: ゲーム画面からのテキスト検出（PaddleOCR）
- **OpenCVベース最適化**: 画像前処理と精度向上
- **差分検出**: 画面変更の高精度検出によるパフォーマンス最適化
- **多言語翻訳**: 複数の翻訳エンジン対応（ローカル＆クラウド）
- **オーバーレイ表示**: 透過的なUI、クリックスルー対応
- **ゲームプロファイル**: ゲーム別の最適設定

### 1.2 差別化要素

- **OpenCVによるOCR最適化**: 各ゲームに最適なOCR設定を調整
- **高度な差分検出**: 画面変更を高精度で検出し、不要な処理をスキップ
- **マルチエンジン対応**: ローカル翻訳とAI支援翻訳の複合利用（ONNXモデル対応）
- **高カスタマイズ性**: オーバーレイの表示位置や見た目を詳細に調整可能
- **低リソース消費**: ゲームパフォーマンスへの影響を最小限に抑えた設計

## 2. アーキテクチャ

Baketaプロジェクトは5つの主要レイヤーから構成されるクリーンアーキテクチャを採用します：

```
Baketa/
├── Baketa.Core/               # コア機能と抽象化
│   ├── Common/                # 共通ユーティリティ
│   ├── Abstractions/          # インターフェース
│   │   ├── Imaging/           # 画像抽象化インターフェース
│   │   └── Platform/          # プラットフォーム抽象化インターフェース
│   ├── Models/                # モデルクラス
│   └── Translation/           # 翻訳関連機能
│       └── Models/            # 翻訳モデル
│
├── Baketa.Infrastructure/     # インフラストラクチャ層
│   ├── OCR/                   # OCR機能実装
│   ├── Translation/           # 翻訳機能実装
│   └── Services/              # サービス実装
│
├── Baketa.Infrastructure.Platform/  # プラットフォーム依存機能
│   ├── Abstractions/          # プラットフォーム抽象化インターフェース
│   ├── Windows/               # Windows実装
│   │   └── NativeMethods/     # P/Invoke定義
│   └── Adapters/              # アダプターレイヤー
│
├── Baketa.Application/        # アプリケーション層 
│   ├── Services/              # アプリケーションサービス
│   ├── DI/                    # 依存性注入管理
│   └── Events/                # イベント処理
│
├── Baketa.UI/                 # UI層
│   ├── Avalonia/              # Avalonia UI実装
│   │   ├── ViewModels/        # MVVMビューモデル
│   │   ├── Views/             # XAMLビュー
│   │   ├── Controls/          # カスタムコントロール
│   │   └── Services/          # UIサービス
│   └── Abstractions/          # UI抽象化
```

### 2.1 Baketa.Core

プラットフォーム非依存のコア機能と抽象化を提供します：

- 基本的なインターフェースと抽象化
- データモデル
- イベント集約機構
- 共通ユーティリティ
- 翻訳関連モデル（Baketa.Core.Translation.Models）

### 2.2 Baketa.Infrastructure

プラットフォーム非依存のインフラストラクチャサービスを提供します：

- OCRエンジン（PaddleOCR）
- 翻訳エンジン連携（ONNX、クラウドAPI）
- 永続化機能
- 共通サービス実装

### 2.3 Baketa.Infrastructure.Platform

Windows固有の実装を担当します：

- プラットフォーム抽象化インターフェース
- Windows固有のプラットフォームサービス
- 画面キャプチャ実装
- 画像処理最適化（OpenCV）
- システムトレイとホットキー
- プラットフォーム依存機能のアダプター
- P/Invoke定義（Windows API呼び出し）

### 2.4 Baketa.Application

ビジネスロジックと機能統合を担当します：

- アプリケーションサービス
- 依存性注入管理
- イベントハンドラー
- 設定管理

### 2.5 Baketa.UI

ユーザーインターフェースとプレゼンテーションロジックを担当します：

- Avalonia UI実装
- ビューモデル
- UI固有サービス
- カスタムコントロール

## 3. 技術スタック

### 3.1 基本構成

- **フレームワーク**: .NET 8 (LTS)
- **UI技術**: Avalonia UI（ReactiveUI）
- **アーキテクチャ**: MVVMパターン
- **OCRエンジン**: PaddleOCR + OpenCV最適化
- **翻訳エンジン**:
  - ローカル: ONNX翻訳モデル、LibreTranslate
  - クラウド: OpenAI API

### 3.2 Windows固有技術

- **プラットフォーム抽象化**: 内部的に抽象化レイヤーを使用するが、現在はWindows実装のみ
- **Windows実装**:
  - 画面キャプチャ: Windows GDI, Direct3D
  - オーバーレイ: Windows層化ウィンドウ（WS_EX_LAYERED）
  - システムトレイ: Windows通知領域API
  - ホットキー: Windows RegisterHotKey API

## 4. イメージ処理アプローチ

Baketaは特にOCR機能を強化するために、下記の画像処理アプローチを採用します：

### 4.1 画像前処理パイプライン

1. **キャプチャ**: 画面または領域のキャプチャ
2. **グレースケール変換**: カラー→グレースケール変換
3. **ノイズ除去**: ガウシアンフィルタなどによるノイズ除去
4. **コントラスト強調**: ヒストグラム均一化
5. **二値化**: 適応的閾値処理
6. **モルフォロジー演算**: 膨張・収縮による文字形状の整形
7. **テキスト領域検出**: MSERまたはエッジベースの検出
8. **ゲーム特性に基づく調整**: ゲームプロファイル設定の適用

### 4.2 差分検出の最適化

ゲームのパフォーマンスを低下させないよう、差分検出を最適化：

- サンプリングベースの高速検出
- テキスト領域に焦点を当てた変化検出
- ヒストグラム分析による効率的な差分識別

### 4.3 プロファイルベース最適化

プロファイルに基づく画像処理パラメータの最適化：

- ゲームごとの専用プロファイル
- 自動パラメータチューニング
- 結果フィードバックによる継続的改善

## 5. プラットフォーム抽象化レイヤーの役割

Baketaプロジェクトは、内部設計として抽象化レイヤーを採用していますが、現時点ではWindows専用アプリケーションとして実装されています：

### 5.1 設計原則

1. **コードの整理**: 関心事の分離によるコード整理とメンテナンス性向上
2. **テスト容易性**: モック可能なインターフェースを通じてテスト容易性を向上
3. **明示的な依存性**: ネイティブAPI呼び出しを明確に分離
4. **コード品質向上**: 明確な責任分離によるコード品質の向上

### 5.2 主要インターフェース

以下のWindows機能へのアクセスを抽象化インターフェースを通して提供:

- **IWindowManager**: Windows ウィンドウ管理機能
- **IScreenCapturer**: 画面キャプチャ機能
- **IKeyboardHook**: キーボードフック機能
- **IImage**: Windows画像表現の抽象化

## 6. 開発ガイドライン

### 6.1 命名規則

- **名前空間**: Baketa.{レイヤー}.{機能領域}
- **インターフェース**: I{名前}
- **抽象クラス**: {名前}Base
- **実装クラス**: {機能}{タイプ}（例: OpenCvImageProcessor）
- **ファイル名**: クラス名と一致させる

### 6.2 コード編成

- 関心の分離を厳格に守る
- 一つのクラスは一つの責任のみを持つ
- サービス間の依存は常にインターフェースを通じて行う
- ビジネスロジックとプラットフォーム固有コードを分離する

### 6.3 ドキュメント

- パブリックAPIには常にXMLドキュメントコメントを付ける
- アーキテクチャの決定は文書化する
- コンポーネント間の連携は図表を含めて説明する

## 7. 実装計画

1. **基盤実装**
   - クリーンアーキテクチャの基盤を構築
   - 名前空間構造の整理
   - 基本インターフェースの定義

2. **コア機能の実装**
   - イメージ抽象化レイヤーの実装
   - OCRシステムの連携
   - 翻訳システムの統合

3. **UI実装**
   - Avalonia UIフレームワークの実装
   - メインウィンドウとオーバーレイ実装
   - 設定UIの実装

4. **配布と運用**
   - インストーラー作成
   - 更新システム構築
   - エラー報告・診断システム

## 8. 最近の改善点

### 8.1 名前空間統一プロジェクト（2025年5月完了）

翻訳関連のデータモデルが以下の2つの名前空間に分散していた問題を解決：

- `Baketa.Core.Models.Translation` (旧)
- `Baketa.Core.Translation.Models` (新・統一)

主な改善点：
- すべての翻訳関連モデルを `Baketa.Core.Translation.Models` に統一
- 名前空間の衝突と型の曖昧参照を排除
- 言語コードの表現を国際標準（ISO 639-1/ISO 3166）に準拠（例: `zh-CN`形式）
- 整理された命名規則とクラス設計

詳細は[名前空間統一完了報告](../development-notes/namespace-unification-completion-report.md)を参照してください。