# ウィンドウ選択とOCR実行分離UI設計仕様書

## 概要
PP-OCRv5多言語対応により翻訳精度が向上した一方、V4/V5モデルの処理時間問題を解決し、ワンショット翻訳とリアルタイム翻訳の両方のUXを改善するため、ウィンドウ選択とOCR実行を分離する新しいUI設計を実装する。

## 背景・課題
### 現在の問題
1. **PP-OCRv5/V4モデルのパフォーマンス**: 初回OCR処理（初期化）に8-15秒以上かかる（V5はより重い）
2. **現行フロー**: `[Start] → [ウィンドウ選択] → [即座にOCR開始] → [長時間待機]`
3. **ワンショット翻訳**: 毎回ウィンドウ選択が必要で使い勝手が悪い
4. **タイムアウト問題**: 翻訳結果表示後も進行中のOCRタイムアウトが継続していた（v5対応で解決済み）

### 重要な前提
- **初期化は初回のみ**: PP-OCRv5/V4モデル初期化は最初の1回のみ時間がかかる
- **その後は高速**: テキスト変更時のOCR処理は1-2秒以内で完了
- **事前処理の効果**: ウィンドウ選択時に初期化を済ませることで、翻訳開始時の待機をゼロに
- **多言語対応**: PP-OCRv5により日本語・英語・中国語・繁体字中国語・ピンインを統一モデルで処理

### 目標
- PP-OCRv5/V4モデルを事前初期化してレスポンス向上
- 対象ウィンドウを記憶してワンショット翻訳を効率化
- ユーザーが翻訳タイミングを制御可能に
- タイムアウト処理の最適化による応答性向上

## 1. UI設計仕様

### 1.1 ボタン構成・状態管理
#### **メインウィンドウ構成**
```
┌─────────────────────────────────┐
│ [ウィンドウ選択]  [Start/Stop]   │
│                                 │
│ 状態: [準備中/準備完了/翻訳中]    │
└─────────────────────────────────┘
```

#### **詳細仕様**
- **状態管理**: メインウィンドウですべての状態を管理
- **「ウィンドウ選択」ボタン**: 
  - 対象ウィンドウの設定専用
  - 選択画面でウィンドウ選択後、選択画面は自動で閉じる
  - 再選択で上書き可能
  - 選択後はバックグラウンドで事前処理開始

- **「Start/Stop」ボタン** (既存ボタンを拡張):
  - **Start**: 翻訳開始（ウィンドウ未選択時は非アクティブ）
  - **Stop**: 翻訳停止（対象ウィンドウ選択状態は維持）
  - 準備完了後にStartがアクティブ化

### 1.2 状態表示・フロー
#### **5段階ステータス**
1. **「初期化中」**: アプリ起動後、OCR初期化実行中（Select非アクティブ）
2. **「未選択」**: 初期化完了、ウィンドウ未選択状態（Start非アクティブ）
3. **「準備中」**: （削除：起動時初期化により不要）
4. **「準備完了」**: ウィンドウ選択済み、翻訳開始可能（Startアクティブ）
5. **「翻訳中」**: リアルタイム翻訳実行中（Stopアクティブ）

#### **視覚的表現（Statusアイコンの色変更）**
- 初期化中: 青（#007BFF）+ プログレス表示
- 未選択: グレー（#6C757D）
- 準備完了: 緑（#28A745）
- 翻訳中: オレンジ（#FD7E14）+ 処理状況表示
- エラー: 赤（#DC3545）

#### **状態遷移フロー（簡略化）**
```
初期化中 ─[OCR初期化完了]→ 未選択 ─[ウィンドウ選択]→ 準備完了
                            ↑                        ↓
                            └─[ウィンドウ再選択]─────┘
                                                    ↓
                                  翻訳中 ←─[Start]──┘
                                    │
                                    └─[Stop]→ 準備完了
```

### 1.3 その他UI要素
- **ウィンドウ選択後の確認表示**: 一旦不要（将来的に追加検討）
- **エラー表示**: 準備失敗時の明確なメッセージ

## 2. 懸念事項・考慮点

### 2.1 技術的懸念
#### **メモリ使用量**
- PP-OCRv5多言語モデル常駐によるメモリ消費増加（V4より大きい）
- 対策: 一定時間非使用時の自動解放機能

#### **プロセス安定性**
- PP-OCRv5のAccessViolationException対策（解決済み）
- バックグラウンド処理中のエラーハンドリング
- 事前処理失敗時の復旧方法
- タイムアウト処理の競合状態（解決済み）

#### **リソース競合**
- 複数ウィンドウからの同時キャプチャ要求
- OCRエンジンの排他制御
- タイムアウトキャンセルとOCR処理の並行制御

### 2.2 UX懸念
#### **待機時間の体感**
- 事前処理中のユーザー体験
- 進捗表示の必要性

#### **操作の直感性**
- 2段階操作の学習コスト
- 従来ユーザーの移行

### 2.3 エッジケース
#### **ウィンドウ状態変化**
- 選択したウィンドウが閉じられた場合
- ウィンドウサイズ・位置変更時の対応

#### **アプリケーション状態**
- アプリ再起動時のウィンドウ選択状態
- 設定保存・復元の範囲

## 3. 次のステップ
1. **動作フロー設計** (要件2)
2. **技術的実装方針** (要件3)
3. **プロトタイプ実装**
4. **ユーザビリティテスト**

## 作成日
2025-07-19

## 更新履歴
- 2025-07-19: 初版作成
- 2025-07-19: UI構成詳細化 - メインウィンドウでの状態管理、Start/Stopボタン仕様、4段階ステータス、状態遷移フロー追加
- 2025-07-19: PP-OCRv5対応版に更新 - 多言語モデル対応、タイムアウトキャンセル機能、安定性向上

## 2. 動作フロー設計 (要件2)

### 2.1 アプリ起動フロー（PP-OCRv5対応版）
```
1. アプリ起動
2. メインウィンドウ表示
3. バックグラウンドでOCR初期化開始
   - PP-OCRv5多言語モデル初期化（8-15秒）
   - 安全設定でAccessViolationException回避
   - 初期化中もUIは操作可能
4. 初期化完了まで[Select]ボタンは「初期化中...」表示
5. 初期化完了後、通常表示に切り替え
6. タイムアウトキャンセル機能により応答性向上
```

### 2.2 ウィンドウ選択フロー（簡略化）
```
1. [ウィンドウ選択]ボタンクリック
2. ウィンドウ選択ダイアログ表示
3. ユーザーがウィンドウを選択
4. 選択ダイアログ自動クローズ
5. メインウィンドウ状態：即座に「準備完了」に遷移
6. [Start]ボタンアクティブ化
```

### 2.2 翻訳実行フロー
```
【開始】
1. [Start]ボタンクリック
2. 状態：「翻訳中」に遷移
3. リアルタイム翻訳開始
4. [Stop]ボタンアクティブ化

【停止】
1. [Stop]ボタンクリック
2. 翻訳処理停止
3. 状態：「準備完了」に戻る
4. [Start]ボタンアクティブ化
5. ※対象ウィンドウ選択状態は維持
```

### 2.3 エラーハンドリングフロー
```
【事前処理失敗】
準備中 → エラー状態 → 未選択に戻る
- エラーメッセージ表示
- ウィンドウ再選択を促す

【翻訳中エラー】
翻訳中 → エラー状態 → 準備完了に戻る  
- エラーメッセージ表示
- ウィンドウ選択状態は維持
```

## 3. 実装計画

### 3.1 現在のメインウィンドウ構成
```
現在:
Min
Start      ← 翻訳開始/停止を担当
Show       ← 翻訳結果表示切り替え
Set        ← 設定画面
---
Status     ← システム状態表示
---
Exit
```

### 3.2 変更後のメインウィンドウ構成  
```
変更後:
Min
Select     ← 新規追加: ウィンドウ選択
Start      ← 既存: 翻訳開始/停止 (ウィンドウ未選択時は非アクティブ)
Show       ← 既存: 翻訳結果表示切り替え
Set        ← 既存: 設定画面
---
Status     ← 拡張: 準備状態管理を追加
---
Exit
```

### 3.3 実装対象ファイル
- **UI定義**: `E:\dev\Baketa\Baketa.UI\Views\MainOverlayView.axaml`
- **ViewModel**: `E:\dev\Baketa\Baketa.UI\ViewModels\MainOverlayViewModel.cs`
- **状態管理**: ViewModelに新しい状態プロパティを追加

## 4. その他の検討事項

### 4.1 ユーザビリティ向上
- **視覚的フィードバック**: Statusアイコンの色変更（青色等）で状態を明確化
- **ツールチップ**: 各状態での詳細情報表示
- **アイコン変更**:
  - Select: 画面共有アイコン（🖥️ + ⬆️）
  - Start/Stop: ビデオカメラアイコン（録画開始/停止）
  - OneShot: カメラアイコン（将来実装用、現時点では非表示）

### 4.2 設定の永続化

- **自動リソース解放**: アイドル時間の設定

### 4.3 将来の拡張性
- **複数ウィンドウ管理**: 複数ウィンドウの切り替え機能
- **プロファイル機能**: ゲームごとの設定保存
