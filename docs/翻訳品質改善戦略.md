# 翻訳品質改善戦略

## 概要

Baketa翻訳エンジンの品質問題を解決し、プラン別の翻訳機能を提供するための技術戦略。

**現在の問題:**
- 入力: 「……複雑でよくわからない」
- 期待: 「...it's complicated and I don't really understand it」
- 実際: 「イエスっ たち たちををを」（意味不明な繰り返し）

**根本原因:** Greedy Searchアルゴリズムによる局所最適解問題

## プラン体系と翻訳エンジン構成

### 無料プラン
- **翻訳エンジン**: OPUS-MT（ローカル実行）
- **特徴**: オフライン動作、高速（<50ms）、リソース軽量
- **目標品質**: 基本理解可能レベル

### 有料プラン  
- **翻訳エンジン**: Gemini API（クラウド実行）
- **特徴**: 最高品質、インターネット必須、レイテンシ高め
- **目標品質**: プロダクションレベル

## 実装フェーズ

### Phase 1: 無料プラン品質改善（最優先）
**期間**: 1-2週間  
**目標**: 現在の品質問題（繰り返し生成）を即座に解決

#### 1.1 Repetition Penalty実装
```csharp
// AlphaOpusMtTranslationEngine.cs修正
for (int i = 0; i < lastTokenLogits.Length; i++) {
    float score = lastTokenLogits[i];
    
    // 繰り返しペナルティ適用
    if (outputTokens.Contains(i)) {
        score /= repetitionPenalty; // 推奨: 1.2
    }
    
    if (score > maxScore) {
        maxScore = score;
        nextTokenId = i;
    }
}
```

**期待効果**: 翻訳品質30-50%向上、繰り返し問題解消

#### 1.2 品質テスト実装
- Repetition Penalty効果の定量評価
- テストケース拡充
- 品質メトリクス導入

### Phase 2: 有料プラン実装（中期）
**期間**: 3-4週間  
**目標**: Gemini APIによる高品質翻訳提供

#### 2.1 Gemini API統合
```csharp
public class GeminiTranslationEngine : ITranslationEngine
{
    private readonly GeminiApiClient _client;
    
    public async Task<TranslationResponse> TranslateAsync(TranslationRequest request)
    {
        var prompt = $"Translate the following Japanese text to English: {request.Text}";
        var response = await _client.GenerateContentAsync(prompt);
        
        return TranslationResponse.Success(
            response.Text, 
            request.TargetLanguage
        );
    }
}
```

#### 2.2 プラン別エンジン切り替え
```csharp
public class TranslationEngineFactory
{
    public ITranslationEngine CreateEngine(UserPlan plan)
    {
        return plan switch
        {
            UserPlan.Free => new AlphaOpusMtTranslationEngine(...),
            UserPlan.Premium => new GeminiTranslationEngine(...),
            _ => throw new ArgumentException($"Unknown plan: {plan}")
        };
    }
}
```

#### 2.3 使用量制限・課金連携
- API使用量監視
- 月間制限実装
- 課金システム連携

## 技術的詳細

### OPUS-MT改善項目（Phase 1）

#### Repetition Penalty実装
**パラメータ**: `repetition_penalty = 1.2`（Gemini専門家推奨）
**対象**: 直前に生成済みトークンのスコア減点
**効果**: 「た ら らら」「イエスっ たち たち」などの繰り返し解消

#### 追加改善候補（Phase 1拡張）
- **Temperature Scaling**: 出力の多様性向上
- **Top-k Sampling**: 確率分布の改善
- **Length Penalty**: 適切な文長生成

### Gemini API仕様（Phase 2）

#### API利用方法
- **入力**: OCR認識テキストをそのまま送信
- **前処理**: トークナイザー不要
- **プロンプト**: 「Translate the following Japanese text to English: {text}」

#### コスト管理
- **Gemini API料金**: 入力$2.5/1M tokens、出力$10/1M tokens
- **想定使用量**: 1日1000回翻訳 → 月額$1-5程度
- **制限機能**: 月間API使用量上限設定

## 品質評価指標

### 無料プラン目標（OPUS-MT）
- ✅ 繰り返し生成の解消
- ✅ 基本的な意味伝達（60-70%精度）
- ✅ オフライン動作保証

### 有料プラン目標（Gemini API）
- ✅ プロダクション品質（90%+精度）
- ✅ 自然な表現生成
- ✅ 文脈理解能力

## 実装優先度

| タスク | 優先度 | 期間 | 担当 |
|---|---|---|---|
| Repetition Penalty実装 | **最高** | 2-3日 | メイン |
| OPUS-MT品質テスト | **高** | 1週間 | メイン |
| Gemini API統合 | **中** | 2週間 | メイン |
| プラン切り替えUI | **中** | 1週間 | UI担当 |
| 使用量制限機能 | **低** | 1週間 | メイン |

## リスク管理

### Phase 1リスク
- **Repetition Penalty効果不十分**: Temperature Scalingで補完
- **新たな品質問題発生**: テストケース拡充で早期発見

### Phase 2リスク
- **Gemini APIコスト予想超過**: 使用量制限・アラート機能
- **API障害**: フォールバック機能は**実装しない**（プラン別割り切り）

## 成功指標

### Phase 1成功条件
- [ ] 「……複雑でよくわからない」が適切に翻訳される
- [ ] 繰り返し文字列生成が99%以上解消
- [ ] 翻訳レイテンシが100ms以下を維持

### Phase 2成功条件
- [ ] Gemini API翻訳精度90%以上
- [ ] プラン切り替えが正常動作
- [ ] 月間API費用が予算内（$10以下）

---

**最終更新**: 2025-08-03  
**承認状況**: Phase 1承認済み、Phase 2実装予定