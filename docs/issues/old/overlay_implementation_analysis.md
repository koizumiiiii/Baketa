# オーバーレイ実装の分析と移行検討

## 1. 背景

翻訳結果を表示するオーバーレイウィンドウの背景に、ブラー効果（すりガラス）を適用したいという要件が挙がった。
現在のオーバーレイ実装はWin32 API（`LayeredOverlayWindow`）を直接利用しており、この方式ではOSバージョンに依存せずに安定したブラー効果を実装することが困難である。

代替案として、UIフレームワークであるAvaloniaのウィンドウに置き換えることを検討する。本ドキュメントでは、その際の技術的な影響範囲、パフォーマンス、実現可能性について分析した結果をまとめる。

## 2. 現在の実装 (Win32 Layered Window)

- **クラス**: `Baketa.Infrastructure.Platform.Windows.Overlay.LayeredOverlayWindow`
- **技術**: Win32 APIをP/Invokeで呼び出し、`WS_EX_LAYERED` スタイルを持つウィンドウを作成。GDI+を用いて32bit ARGBのビットマップを描画し、`UpdateLayeredWindow` APIでウィンドウ内容を更新している。
- **特徴**:
    - **軽量**: CPU、メモリ消費が非常に少ない。
    - **高制御**: `WS_EX_TRANSPARENT`（クリックスルー）、`WS_EX_NOACTIVATE`（非アクティブ化）、`WS_EX_TOPMOST`（最前面表示）といった、ゲームオーバーレイに必要な特殊なウィンドウ挙動を細かく制御できる。
- **課題**:
    - **ブラー効果の実装困難**: DWM APIを利用する必要があるが、`WS_EX_LAYERED` とは排他利用となり、根本的な作り直しが必要。また、利用するAPIによってはWindows 11以降でしか動作しないなど、OSバージョン互換性の問題が発生する。
    - **保守性の低さ**: Win32 APIとGDI+に関する深い知識が必要で、コードが複雑化しやすい。

## 3. 移行案 (Avalonia Window)

現在のWin32実装を、Avaloniaが提供する標準の `Window` クラスに置き換える。

### 3.1. 影響範囲

クリーンアーキテクチャの恩恵により、変更は主にインフラ層に集中する。

- **影響が大きい箇所**:
    - `Baketa.Infrastructure.Platform` プロジェクト:
        - `Windows/Overlay/LayeredOverlayWindow.cs`: Avaloniaの`Window`をベースとした新しいクラスに置き換えられるため、削除対象。
        - `Windows/Overlay/LayeredOverlayWindowFactory.cs`: 同様に不要となり削除。
        - `Windows/Overlay/WindowsOverlayWindowManager.cs`: ウィンドウ生成ロジックを、Avaloniaウィンドウをインスタンス化するように全面的に書き換える必要がある。
        - `DI/Modules/OverlayModule.cs`: サービス登録を新しい実装に更新する。
- **影響が小さい・ない箇所**:
    - `Baketa.Core`: `IOverlayWindow` などのインターフェースは変更不要。実装が差し替えられるだけ。
    - `Baketa.Application`, `Baketa.UI`: 上位レイヤーはインターフェースに依存しているため、コード変更はほぼ不要。

### 3.2. パフォーマンス分析

| 項目 | 現在のWin32実装 | Avaloniaへの移行案 |
| :--- | :--- | :--- |
| **CPU/メモリ使用量** | **◎ 非常に軽量** | ○ 軽量だが、Win32実装よりはオーバーヘッド増 |
| **初期化速度** | **◎ 高速** | ○ Win32よりは遅いが、体感できるほどの差はない可能性が高い |
| **描画更新** | ○ GDI+による更新 | ◎ ハードウェアアクセラレーションを活用した高速なレンダリング |

- **懸念点**: Avaloniaは完全なUIフレームワークであり、独自のレンダリングエンジン（Skia）やランタイムを持つ。このオーバーヘッドが、ゲームなどリソースが重要なアプリケーションのパフォーマンスに影響を与える可能性はゼロではない。ただし、テキスト表示程度のシンプルなUIであれば、問題になる可能性は低いと考えられる。

### 3.3. 実装上の課題と実現可能性

オーバーレイ特有のウィンドウ挙動は、Avaloniaの標準機能で実現可能。

| Win32スタイル | Avaloniaでの実現方法 |
| :--- | :--- |
| `WS_EX_TRANSPARENT` (クリックスルー) | ウィンドウ背景を透明に設定することで実現可能。 |
| `WS_EX_NOACTIVATE` (非アクティブ化) | `Window.ShowWithoutActivation` プロパティを利用。 |
| `WS_EX_TOPMOST` (最前面表示) | `Window.Topmost` プロパティを利用。 |

ブラー効果についても、Avaloniaの `Window.TransparencyLevelHint` プロパティや `Backdrop` プロパティを設定するだけで、OSの差異を吸収しつつ簡単に実装できる。

## 4. 結論と推奨

| 観点 | 評価 | 理由 |
| :--- | :--- | :--- |
| **ブラー効果の実装** | ◎ | Avaloniaの組み込み機能でOS非依存に実装でき、最優先課題を解決できる。 |
| **開発・保守性** | ◎ | Win32 APIの複雑さから解放され、モダンで生産性の高い開発が可能になる。 |
| **パフォーマンス** | △ | 理論上のオーバーヘッドは増加する。ただし、実用上の問題になるかは不明。 |

**総合評価**:
パフォーマンス面の若干の懸念は残るものの、最大の目的であるブラー効果の実現、および今後の開発・保守性の向上という大きなメリットを考慮すると、**Avaloniaウィンドウへの移行を強く推奨する**。

**次のステップ**:
本格的な移行作業に入る前に、まずAvaloniaウィンドウでオーバーレイの基本機能（クリックスルー、非アクティブ、最前面表示）とブラー効果を実装した**技術検証用のプロトタイプを作成する**。
このプロトタイプを実際のゲーム画面上で動作させ、CPU・メモリ使用量やフレームレートへの影響を測定し、パフォーマンス懸念を払拭することが望ましい。
