name: Alpha Release

on:
  push:
    tags:
      - 'alpha-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Alpha version (e.g., alpha-0.1.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  PYTHON_VERSION: '3.10.11'
  PYTHON_ARCH: 'amd64'

jobs:
  build-alpha:
    name: Build Alpha Release
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      package-name: ${{ steps.version.outputs.package-name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Determine version
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
          $tag = $version
        } else {
          $tag = "${{ github.ref_name }}"
          $version = $tag
        }
        
        $packageName = "Baketa-$version-win-x64"
        
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "package-name=$packageName" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        
        echo "## Alpha Release Build" >> $env:GITHUB_STEP_SUMMARY
        echo "- Version: $version" >> $env:GITHUB_STEP_SUMMARY
        echo "- Package: $packageName.zip" >> $env:GITHUB_STEP_SUMMARY
        echo "- Target: Alpha Testers" >> $env:GITHUB_STEP_SUMMARY
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install Windows 10 SDK 19041
      run: |
        Write-Host "Installing Windows 10 SDK 19041..."
        choco install windows-sdk-10-version-2004-all --yes --no-progress --force
        Write-Host "Windows 10 SDK installation completed"
      shell: powershell

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Build Native DLL
      run: |
        if exist "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" (
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
        ) else (
          call "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat"
        )
        msbuild BaketaCaptureNative\BaketaCaptureNative.sln /p:Configuration=Release /p:Platform=x64 /v:minimal
      shell: cmd

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: |
        dotnet restore Baketa.sln --verbosity minimal

    - name: Run essential tests
      run: |
        # Run core tests only for alpha releases (exclude LocalOnly and Integration tests)
        # Note: Build happens as part of test execution
        dotnet test tests/Baketa.Core.Tests --configuration Release --verbosity minimal --filter "Category!=LocalOnly&Category!=Integration"
        dotnet test tests/Baketa.Infrastructure.Tests --configuration Release --verbosity minimal --filter "Category!=LocalOnly&Category!=Integration"
      continue-on-error: true
    
    - name: Publish application
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $outputDir = "./publish/Baketa-$version"

        dotnet publish Baketa.UI/Baketa.UI.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output $outputDir `
          --verbosity minimal `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true

    - name: Copy Native DLL to publish directory
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"

        # Copy BaketaCaptureNative.dll
        Copy-Item "BaketaCaptureNative/bin/Release/BaketaCaptureNative.dll" "$publishDir/" -Force -Verbose
        Copy-Item "BaketaCaptureNative/bin/Release/BaketaCaptureNative.pdb" "$publishDir/" -Force -ErrorAction SilentlyContinue

        Write-Host "Native DLL copied to publish directory"
      shell: powershell

    # ðŸ”¥ [ALPHA_0.1.2] Modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚³ãƒ”ãƒ¼ã‚’å‰Šé™¤
    # HuggingFace Hubçµ±åˆã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã¯åˆå›žèµ·å‹•æ™‚ã«è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™
    # ã“ã‚Œã«ã‚ˆã‚Šé…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè»½é‡åŒ–ï¼ˆ~600MBå‰Šæ¸›ï¼‰ã•ã‚Œã¾ã™

    - name: Create alpha package
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $packageName = "${{ steps.version.outputs.package-name }}"

        # Copy additional files for alpha testing
        Copy-Item "README.md" "$publishDir/"

        # Copy Python gRPC server directory
        Copy-Item "grpc_server" "$publishDir/" -Recurse -Force -Verbose
        Write-Host "grpc_server directory copied to publish directory"

    - name: Download and setup Python Embeddable
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $vendorPythonDir = "$publishDir/vendor/python"

        # Get Python version from environment variables
        $pythonVersion = "${{ env.PYTHON_VERSION }}"
        $pythonArch = "${{ env.PYTHON_ARCH }}"

        # Download Python Embeddable
        Write-Host "Downloading Python $pythonVersion Embeddable ($pythonArch)..."
        $pythonUrl = "https://www.python.org/ftp/python/$pythonVersion/python-$pythonVersion-embed-$pythonArch.zip"
        $pythonZip = "./python-embed.zip"
        Write-Host "Download URL: $pythonUrl"
        Invoke-WebRequest -Uri $pythonUrl -OutFile $pythonZip -UseBasicParsing

        # Extract to vendor/python
        Write-Host "Extracting Python to vendor/python..."
        New-Item -ItemType Directory -Path $vendorPythonDir -Force | Out-Null
        Expand-Archive -Path $pythonZip -DestinationPath $vendorPythonDir -Force

        # Configure Python paths (enable import site for pip)
        # Build ._pth filename dynamically from version (e.g., 3.10.11 -> python310._pth)
        Write-Host "Configuring Python paths..."
        $versionParts = $pythonVersion.Split('.')
        $pthFileName = "python$($versionParts[0])$($versionParts[1])._pth"
        $pthFile = "$vendorPythonDir/$pthFileName"
        Write-Host "PTH file: $pthFileName"
        $pthContent = Get-Content $pthFile -Raw
        $pthContent = $pthContent -replace '(?m)^#import site', 'import site'
        $pthContent | Set-Content $pthFile -NoNewline

        # Download and install pip
        Write-Host "Installing pip..."
        $getPipUrl = "https://bootstrap.pypa.io/get-pip.py"
        $getPipPath = "./get-pip.py"
        Invoke-WebRequest -Uri $getPipUrl -OutFile $getPipPath -UseBasicParsing
        & "$vendorPythonDir/python.exe" $getPipPath --no-warn-script-location

        # Install required packages from requirements.txt
        Write-Host "Installing required packages from requirements.txt..."
        & "$vendorPythonDir/python.exe" -m pip install --no-warn-script-location --no-cache-dir -r requirements.txt

        # Verify installation
        Write-Host "Verifying installed packages..."
        & "$vendorPythonDir/python.exe" -m pip list

        Write-Host "Python Embeddable setup completed"

        # Check installation size
        $pythonSize = [math]::Round((Get-ChildItem $vendorPythonDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)
        Write-Host "Python installation size: $pythonSize MB"
      shell: powershell

    - name: Create alpha package
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $packageName = "${{ steps.version.outputs.package-name }}"

        # Copy additional files for alpha testing
        Copy-Item "README.md" "$publishDir/"

        # Create alpha-specific readme
        @"
        # Baketa Alpha Test $version

        Thank you for participating in the Baketa alpha test!

        ## Quick Start
        1. Extract this package to any folder
        2. Run Baketa.UI.exe
        3. Follow the initial setup wizard
        4. Start translating!

        ## Alpha Test Features
        - Local translation (Japanese â†” English)
        - Basic OCR with PaddleOCR
        - Simple overlay display
        - Essential settings

        ## Known Limitations (Alpha)
        - No cloud translation features
        - No user accounts/login
        - Limited language pairs
        - Basic UI (full UI coming in beta)

        ## Feedback
        Please report issues at: https://github.com/koizumiiiii/Baketa/issues
        Use the [Bug Report] template and mention this is an alpha version.

        ## System Requirements
        - Windows 10/11 (x64)
        - 4GB RAM minimum
        - 1GB disk space

        Version: $version
        Build Date: $(Get-Date -Format 'yyyy-MM-dd')
        "@ | Out-File -FilePath "$publishDir/ALPHA_README.txt" -Encoding UTF8
        
        # Create package
        Compress-Archive -Path "$publishDir/*" -DestinationPath "./publish/$packageName.zip" -Force
        
        # Calculate size
        $size = [math]::Round((Get-Item "./publish/$packageName.zip").Length / 1MB, 2)
        echo "Package size: $size MB" >> $env:GITHUB_STEP_SUMMARY
    
    - name: Upload alpha package
      uses: actions/upload-artifact@v5
      with:
        name: alpha-package
        path: ./publish/*.zip
        retention-days: 90

  create-alpha-release:
    name: Create Alpha Release
    runs-on: ubuntu-latest
    needs: build-alpha
    
    permissions:
      contents: write
    
    steps:
    - name: Download package
      uses: actions/download-artifact@v6
      with:
        name: alpha-package
        path: ./package
    
    - name: Create alpha release notes
      run: |
        version="${{ needs.build-alpha.outputs.version }}"
        
        cat > alpha_release_notes.md << EOF
        # ðŸ§ª Baketa Alpha Test $version
        
        **This is an alpha test release for early feedback - not for production use!**
        
        ## What's New in This Alpha
        
        - âœ… Local Japanese â†” English translation
        - âœ… Basic OCR text detection
        - âœ… Simple overlay display system
        - âœ… Essential settings and preferences
        
        ## Alpha Test Focus
        
        This alpha focuses on **core translation functionality**:
        - Test translation accuracy and speed
        - Verify OCR text detection works in your games
        - Check overlay positioning and visibility
        - Validate basic performance and stability
        
        ## What's NOT in This Alpha
        
        - âŒ User accounts/authentication
        - âŒ Cloud translation services
        - âŒ Advanced UI features
        - âŒ Extended language support
        - âŒ Game-specific profiles
        
        ## Download & Installation
        
        1. Download \`${{ needs.build-alpha.outputs.package-name }}.zip\`
        2. Extract to any folder (e.g., \`C:\Baketa\`)
        3. Run \`Baketa.UI.exe\`
        4. Follow the setup wizard
        
        ## System Requirements
        
        - Windows 10/11 (64-bit)
        - 4GB RAM minimum
        - 1GB free disk space
        - No additional software required (self-contained)
        
        ## How to Provide Feedback
        
        Found a bug? Have suggestions? Please help us improve:
        
        1. Go to [Issues](https://github.com/koizumiiiii/Baketa/issues)
        2. Click "New Issue" 
        3. Choose "Bug Report" template
        4. **Mention this alpha version: $version**
        5. Provide as much detail as possible
        
        ## Privacy & Data
        
        This alpha version:
        - âœ… Works completely offline
        - âœ… No data sent to external servers
        - âœ… No telemetry or tracking
        - âœ… All processing happens locally
        
        ## Known Issues
        
        - OCR may require adjustment for some games
        - Translation speed varies by text length
        - Overlay positioning may need manual adjustment
        - Some Windows scaling settings may affect display
        
        ---
        
        **Thank you for testing Baketa! Your feedback helps make it better for everyone.** ðŸš€
        EOF
    
    - name: Create Alpha Release
      uses: softprops/action-gh-release@v2
      with:
        name: "ðŸ§ª Alpha Test ${{ needs.build-alpha.outputs.version }}"
        tag_name: ${{ needs.build-alpha.outputs.version }}
        body_path: alpha_release_notes.md
        files: ./package/*.zip
        prerelease: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}