name: Build and Deploy BaketaUnifiedServer

# Issue #360: BaketaUnifiedServer CI/CD
# Proto/„Çµ„Éº„Éê„Éº„Ç≥„Éº„ÉâÂ§âÊõ¥ÊôÇ„Å´Ëá™Âãï„Éì„É´„Éâ„Éª„Éá„Éó„É≠„Ç§

on:
  push:
    branches:
      - main
    paths:
      - 'grpc_server/**'
      - '**/*.proto'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild even without changes'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  build-unified-server:
    name: Build BaketaUnifiedServer (CPU)
    runs-on: windows-latest

    permissions:
      contents: write

    defaults:
      run:
        shell: pwsh
        working-directory: grpc_server

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v5
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-unified-server-${{ hashFiles('grpc_server/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-unified-server-

    - name: Install dependencies
      run: |
        Write-Host "üì¶ Installing dependencies..."
        python -m pip install --upgrade pip

        # Base requirements
        pip install -r requirements.txt

        # Additional dependencies for OCR (Surya)
        pip install Pillow opencv-python-headless
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install surya-ocr transformers safetensors einops pydantic

        # PyInstaller for building
        pip install pyinstaller

        Write-Host "‚úÖ Dependencies installed"

    - name: Verify proto files
      run: |
        Write-Host "üîß Verifying proto files (using committed versions with relative imports)..."

        # [Issue #365 Èñ¢ÈÄ£] CI/CD„ÅßprotoÂÜçÁîüÊàê„Åô„Çã„Å®Áµ∂ÂØæ„Ç§„É≥„Éù„Éº„Éà„Å´„Å™„Çä„ÄÅ
        # PyInstaller„Éê„É≥„Éâ„É´ÂÜÖ„ÅßÂãï‰Ωú„Åó„Å™„ÅÑ„ÄÇ„É™„Éù„Ç∏„Éà„É™„ÅÆÁõ∏ÂØæ„Ç§„É≥„Éù„Éº„ÉàÁâà„Çí‰ΩøÁî®„Åô„Çã„ÄÇ

        # Verify required proto files exist
        $requiredFiles = @(
          "protos/ocr_pb2.py",
          "protos/ocr_pb2_grpc.py",
          "protos/__init__.py"
        )

        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            Write-Host "‚ùå Missing required proto file: $file"
            exit 1
          }
          Write-Host "‚úì Found: $file"
        }

        # Verify relative imports are present (sanity check)
        $content = Get-Content "protos/ocr_pb2_grpc.py" -Raw
        if ($content -notmatch "from protos import") {
          Write-Host "‚ö†Ô∏è Warning: Proto file may not have relative imports"
        }

        Write-Host "‚úÖ Proto files verified"

    - name: Build with PyInstaller
      run: |
        Write-Host "üî® Building BaketaUnifiedServer with PyInstaller..."
        pyinstaller BaketaUnifiedServer.spec --noconfirm

        # Verify build
        $exePath = "dist/BaketaUnifiedServer/BaketaUnifiedServer.exe"
        if (Test-Path $exePath) {
          $size = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          Write-Host "‚úÖ Build successful: BaketaUnifiedServer.exe ($size MB)"
        } else {
          Write-Host "‚ùå Build failed: exe not found"
          exit 1
        }

    - name: Create zip package
      run: |
        Write-Host "üì¶ Creating zip package..."

        # Get folder size
        $folderSize = [math]::Round((Get-ChildItem -Path "dist/BaketaUnifiedServer" -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB, 2)
        Write-Host "Folder size: $folderSize MB"

        # Create zip
        Compress-Archive -Path "dist/BaketaUnifiedServer/*" -DestinationPath "BaketaUnifiedServer-cpu.zip" -Force

        $zipSize = [math]::Round((Get-Item "BaketaUnifiedServer-cpu.zip").Length / 1MB, 2)
        Write-Host "‚úÖ Zip created: BaketaUnifiedServer-cpu.zip ($zipSize MB)"

        echo "## Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "- Folder size: $folderSize MB" >> $env:GITHUB_STEP_SUMMARY
        echo "- Zip size: $zipSize MB" >> $env:GITHUB_STEP_SUMMARY

    - name: Get current version info
      id: version
      working-directory: .
      run: |
        # Get latest commit info
        $commitHash = git rev-parse --short HEAD
        $commitDate = git log -1 --format="%ci" | ForEach-Object { $_.Substring(0, 10) }

        echo "commit-hash=$commitHash" >> $env:GITHUB_OUTPUT
        echo "commit-date=$commitDate" >> $env:GITHUB_OUTPUT

        Write-Host "Commit: $commitHash ($commitDate)"

    - name: Update models-v3 release
      working-directory: .
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "üöÄ Updating models-v3 release..."

        $zipPath = "grpc_server/BaketaUnifiedServer-cpu.zip"
        $commitHash = "${{ steps.version.outputs.commit-hash }}"
        $commitDate = "${{ steps.version.outputs.commit-date }}"

        # Check if models-v3 release exists
        $releaseExists = gh release view models-v3 2>&1
        if ($LASTEXITCODE -ne 0) {
          Write-Host "‚ùå models-v3 release not found. Please create it manually first."
          exit 1
        }

        # Upload new asset (--clobber overwrites existing)
        Write-Host "Uploading BaketaUnifiedServer-cpu.zip..."
        gh release upload models-v3 $zipPath --clobber

        if ($LASTEXITCODE -eq 0) {
          Write-Host "‚úÖ Successfully updated models-v3 release"

          # Update release notes with build info
          $notesFile = "release-notes.md"
          @(
            "## Model Assets v3",
            "",
            "This release contains model assets for Baketa.",
            "",
            "### BaketaUnifiedServer (CPU)",
            "- **Last updated**: $commitDate",
            "- **Commit**: $commitHash",
            "- **Auto-built by**: GitHub Actions (Issue #360)",
            "",
            "### Other Assets",
            "- nllb-200-onnx-int8.zip - Translation model (ONNX INT8)"
          ) | Out-File -FilePath $notesFile -Encoding utf8

          gh release edit models-v3 --notes-file $notesFile
          Remove-Item $notesFile

          echo "## Deployment" >> $env:GITHUB_STEP_SUMMARY
          echo "- Release: models-v3" >> $env:GITHUB_STEP_SUMMARY
          echo "- Asset: BaketaUnifiedServer-cpu.zip" >> $env:GITHUB_STEP_SUMMARY
          echo "- Commit: $commitHash" >> $env:GITHUB_STEP_SUMMARY
        } else {
          Write-Host "‚ùå Failed to upload to models-v3"
          exit 1
        }
