name: Release Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
      - 'beta-*'

env:
  DOTNET_VERSION: '8.0.x'
  PYTHON_VERSION: '3.10'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Build .NET Application
  build-dotnet:
    name: Build .NET Application
    runs-on: windows-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Extract version info
      id: version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        $isPrerelease = $tag -match '^(alpha|beta|v.*-(alpha|beta|rc))'

        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "is-prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT

        echo "## Release Information" >> $env:GITHUB_STEP_SUMMARY
        echo "- Tag: $tag" >> $env:GITHUB_STEP_SUMMARY
        echo "- Version: $version" >> $env:GITHUB_STEP_SUMMARY
        echo "- Pre-release: $isPrerelease" >> $env:GITHUB_STEP_SUMMARY

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install Windows SDK 10.0.19041.0 with UWP components
      run: |
        # CsWinRT requires UAP Platform.xml which is part of Windows SDK UWP components
        # Download and install Windows SDK 10.0.19041.0 with UAP components
        $sdkUrl = "https://go.microsoft.com/fwlink/?linkid=2120843"
        $installerPath = "$env:TEMP\winsdksetup.exe"

        Write-Host "Downloading Windows SDK 10.0.19041.0..."
        Invoke-WebRequest -Uri $sdkUrl -OutFile $installerPath -UseBasicParsing

        Write-Host "Installing Windows SDK with UWP components..."
        # Install SDK features needed for CsWinRT (Desktop C++ ARM64 includes UAP)
        Start-Process -FilePath $installerPath -ArgumentList "/features OptionId.UWPCpp /q /norestart" -Wait -NoNewWindow

        # Verify installation
        $platformXml = "C:\Program Files (x86)\Windows Kits\10\Platforms\UAP\10.0.19041.0\Platform.xml"
        if (Test-Path $platformXml) {
          Write-Host "✅ Windows SDK UAP components installed successfully"
        } else {
          Write-Host "⚠️ Platform.xml not found, listing available platforms..."
          Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Platforms\" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
        }
      shell: pwsh

    - name: Publish UI application
      run: |
        dotnet publish Baketa.UI/Baketa.UI.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          -p:IS_DISTRIBUTION=true `
          --output ./publish/Baketa-${{ steps.version.outputs.version }} `
          --verbosity minimal

    - name: Create .NET package
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $zipName = "Baketa-$version-win-x64.zip"

        # Copy additional files
        Copy-Item "README.md" "$publishDir/" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$publishDir/" -ErrorAction SilentlyContinue

        # Create zip package
        Compress-Archive -Path "$publishDir/*" -DestinationPath "./publish/$zipName" -Force

        $size = [math]::Round((Get-Item "./publish/$zipName").Length / 1MB, 2)
        echo "## .NET Package" >> $env:GITHUB_STEP_SUMMARY
        echo "- Package: $zipName" >> $env:GITHUB_STEP_SUMMARY
        echo "- Size: $size MB" >> $env:GITHUB_STEP_SUMMARY

    - name: Upload .NET artifact
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-package
        path: ./publish/*.zip
        retention-days: 7

  # Job 2: Build Translation Server with PyInstaller
  build-translation-server:
    name: Build Translation Server
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'grpc_server/requirements.txt'

    - name: Install dependencies
      run: |
        cd grpc_server
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        cd grpc_server
        pyinstaller BaketaTranslationServer.spec --clean --noconfirm

    - name: Create Translation Server package
      run: |
        $distPath = "grpc_server/dist/BaketaTranslationServer"
        $zipName = "BaketaTranslationServer.zip"

        # Ensure publish directory exists
        New-Item -ItemType Directory -Path "./publish" -Force | Out-Null

        if (Test-Path $distPath) {
          Compress-Archive -Path "$distPath/*" -DestinationPath "./publish/$zipName" -Force

          $size = [math]::Round((Get-Item "./publish/$zipName").Length / 1MB, 2)
          echo "## Translation Server Package" >> $env:GITHUB_STEP_SUMMARY
          echo "- Package: $zipName" >> $env:GITHUB_STEP_SUMMARY
          echo "- Size: $size MB" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "::error::PyInstaller build failed - dist directory not found"
          exit 1
        }
      shell: pwsh

    - name: Upload Translation Server artifact
      uses: actions/upload-artifact@v4
      with:
        name: translation-server-package
        path: ./publish/BaketaTranslationServer.zip
        retention-days: 7

  # Job 3: Build Surya OCR Server with PyInstaller
  build-surya-ocr-server:
    name: Build Surya OCR Server
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'grpc_server/requirements.txt'

    - name: Install dependencies
      run: |
        cd grpc_server
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        # Surya OCR dependencies
        pip install surya-ocr torch torchvision

    - name: Build with PyInstaller
      run: |
        cd grpc_server
        pyinstaller BaketaSuryaOcrServer.spec --clean --noconfirm

    - name: Create Surya OCR Server package
      run: |
        $distPath = "grpc_server/dist/BaketaSuryaOcrServer"
        $zipName = "BaketaSuryaOcrServer.zip"

        # Ensure publish directory exists
        New-Item -ItemType Directory -Path "./publish" -Force | Out-Null

        if (Test-Path $distPath) {
          Compress-Archive -Path "$distPath/*" -DestinationPath "./publish/$zipName" -Force

          $size = [math]::Round((Get-Item "./publish/$zipName").Length / 1MB, 2)
          echo "## Surya OCR Server Package" >> $env:GITHUB_STEP_SUMMARY
          echo "- Package: $zipName" >> $env:GITHUB_STEP_SUMMARY
          echo "- Size: $size MB" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "::error::PyInstaller build failed - dist directory not found"
          exit 1
        }
      shell: pwsh

    - name: Upload Surya OCR Server artifact
      uses: actions/upload-artifact@v4
      with:
        name: surya-ocr-server-package
        path: ./publish/BaketaSuryaOcrServer.zip
        retention-days: 7

  # Job 4: Package Surya OCR Models
  package-ocr-models:
    name: Package Surya OCR Models
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download and package Surya OCR models
      run: |
        # Download Surya models from models-v1 release (pre-uploaded)
        echo "Downloading Surya OCR models..."

        # Detection Model (ONNX INT8 quantized) - ~31MB
        curl -L -o surya-detection-onnx.zip \
          "https://github.com/koizumiiiii/Baketa/releases/download/models-v1/surya-detection-onnx.zip" || \
          echo "::warning::Surya detection model download failed, may need manual upload"

        # Recognition Model (PyTorch) - ~1.1GB
        curl -L -o surya-recognition-pytorch.zip \
          "https://github.com/koizumiiiii/Baketa/releases/download/models-v1/surya-recognition-pytorch.zip" || \
          echo "::warning::Surya recognition model download failed, may need manual upload"

        echo "## Surya OCR Models Package" >> $GITHUB_STEP_SUMMARY
        echo "- Detection (ONNX INT8): surya-detection-onnx.zip" >> $GITHUB_STEP_SUMMARY
        ls -lh surya-detection-onnx.zip >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  (not available)" >> $GITHUB_STEP_SUMMARY
        echo "- Recognition (PyTorch): surya-recognition-pytorch.zip" >> $GITHUB_STEP_SUMMARY
        ls -lh surya-recognition-pytorch.zip >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  (not available)" >> $GITHUB_STEP_SUMMARY

    - name: Upload OCR models artifact
      uses: actions/upload-artifact@v4
      with:
        name: ocr-models-package
        path: |
          surya-detection-onnx.zip
          surya-recognition-pytorch.zip
        retention-days: 7
        if-no-files-found: warn

  # Job 5: Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-dotnet, build-translation-server, build-surya-ocr-server, package-ocr-models]

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: List artifacts
      run: |
        echo "## Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
        find ./artifacts -type f -name "*.zip" | while read f; do
          size=$(ls -lh "$f" | awk '{print $5}')
          echo "- $(basename $f): $size" >> $GITHUB_STEP_SUMMARY
        done
        ls -laR ./artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find ./artifacts -name "*.zip" -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Generate release notes
      run: |
        version="${{ needs.build-dotnet.outputs.version }}"

        cat > release_notes.md << 'EOF'
        ## Baketa $VERSION

        ### Downloads

        | File | Description | Size |
        |------|-------------|------|
        | `Baketa-$VERSION-win-x64.zip` | Main application (Windows x64) | ~50MB |
        | `BaketaTranslationServer.zip` | Translation server (auto-downloaded) | ~200MB |
        | `BaketaSuryaOcrServer.zip` | Surya OCR server (auto-downloaded) | ~2GB |
        | `surya-detection-onnx.zip` | Surya Detection ONNX INT8 (auto-downloaded) | ~31MB |
        | `surya-recognition-pytorch.zip` | Surya Recognition PyTorch (auto-downloaded) | ~1.1GB |

        ### Installation

        1. Download `Baketa-$VERSION-win-x64.zip`
        2. Extract to desired location
        3. Run `Baketa.UI.exe`
        4. On first run, required components will be downloaded automatically

        ### OCR Engine

        Baketa uses **Surya OCR** for high accuracy Japanese text recognition (~1.1GB models)

        ### NLLB Translation Model

        The NLLB-200 translation model (~1.1GB) is downloaded from HuggingFace on first use.
        For manual download, get `nllb-200-distilled-600M-ct2.zip` from a previous release.

        ### System Requirements

        - Windows 10/11 (x64)
        - Internet connection (for first-time setup)
        - ~4GB disk space (including OCR models and translation server)

        EOF

        sed -i "s/\$VERSION/$version/g" release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: "Baketa ${{ needs.build-dotnet.outputs.version }}"
        body_path: release_notes.md
        files: release-assets/*.zip
        prerelease: ${{ needs.build-dotnet.outputs.is-prerelease == 'true' }}
        make_latest: ${{ needs.build-dotnet.outputs.is-prerelease == 'false' }}
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
