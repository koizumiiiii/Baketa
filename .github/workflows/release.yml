name: Release Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
      - 'beta-*'

env:
  DOTNET_VERSION: '8.0.x'
  PYTHON_VERSION: '3.10'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Build .NET Application and Create Release
  build-and-release:
    name: Build and Release
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Extract version info
      id: version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        $isPrerelease = $tag -match '^(alpha|beta|v.*-(alpha|beta|rc))'

        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "is-prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT

        echo "## Release Information" >> $env:GITHUB_STEP_SUMMARY
        echo "- Tag: $tag" >> $env:GITHUB_STEP_SUMMARY
        echo "- Version: $version" >> $env:GITHUB_STEP_SUMMARY
        echo "- Pre-release: $isPrerelease" >> $env:GITHUB_STEP_SUMMARY

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install Windows SDK 10.0.19041.0 with UWP components
      run: |
        # CsWinRT requires UAP Platform.xml which is part of Windows SDK UWP components
        # Download and install Windows SDK 10.0.19041.0 with UAP components
        $sdkUrl = "https://go.microsoft.com/fwlink/?linkid=2120843"
        $installerPath = "$env:TEMP\winsdksetup.exe"

        Write-Host "Downloading Windows SDK 10.0.19041.0..."
        Invoke-WebRequest -Uri $sdkUrl -OutFile $installerPath -UseBasicParsing

        Write-Host "Installing Windows SDK with UWP components..."
        # Install SDK features needed for CsWinRT (Desktop C++ ARM64 includes UAP)
        Start-Process -FilePath $installerPath -ArgumentList "/features OptionId.UWPCpp /q /norestart" -Wait -NoNewWindow

        # Verify installation
        $platformXml = "C:\Program Files (x86)\Windows Kits\10\Platforms\UAP\10.0.19041.0\Platform.xml"
        if (Test-Path $platformXml) {
          Write-Host "âœ… Windows SDK UAP components installed successfully"
        } else {
          Write-Host "âš ï¸ Platform.xml not found, listing available platforms..."
          Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Platforms\" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
        }
      shell: pwsh

    - name: Setup Python for PyInstaller
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Build Translation Server with PyInstaller
      run: |
        Write-Host "ðŸ“¦ Building BaketaTranslationServer with PyInstaller..."

        cd grpc_server

        # Install dependencies
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

        # Build with PyInstaller
        pyinstaller BaketaTranslationServer.spec --clean

        # Verify build
        $exePath = "dist\BaketaTranslationServer\BaketaTranslationServer.exe"
        if (Test-Path $exePath) {
          Write-Host "âœ… BaketaTranslationServer.exe built successfully"
          $size = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          Write-Host "   Size: $size MB"
        } else {
          Write-Host "âŒ BaketaTranslationServer.exe not found!"
          exit 1
        }

        cd ..
      shell: pwsh

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build Native DLL (BaketaCaptureNative)
      run: |
        Write-Host "ðŸ”¨ Building BaketaCaptureNative.dll (C++/WinRT)..."
        msbuild BaketaCaptureNative\BaketaCaptureNative.vcxproj /p:Configuration=Release /p:Platform=x64 /verbosity:minimal

        # Verify DLL was built
        $dllPath = "BaketaCaptureNative\bin\Release\BaketaCaptureNative.dll"
        if (Test-Path $dllPath) {
          Write-Host "âœ… BaketaCaptureNative.dll built successfully"
          $size = [math]::Round((Get-Item $dllPath).Length / 1KB, 2)
          Write-Host "   Size: $size KB"
        } else {
          Write-Host "âŒ BaketaCaptureNative.dll not found!"
          exit 1
        }
      shell: pwsh

    - name: Publish UI application
      run: |
        dotnet publish Baketa.UI/Baketa.UI.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          -p:IS_DISTRIBUTION=true `
          --output ./publish/Baketa-${{ steps.version.outputs.version }} `
          --verbosity minimal

    - name: Copy Native DLL to publish directory
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $dllSource = "BaketaCaptureNative\bin\Release\BaketaCaptureNative.dll"

        Write-Host "ðŸ“¦ Copying BaketaCaptureNative.dll to publish directory..."
        Copy-Item $dllSource $publishDir -Force

        if (Test-Path "$publishDir\BaketaCaptureNative.dll") {
          Write-Host "âœ… Native DLL copied successfully"
        } else {
          Write-Host "âŒ Failed to copy native DLL!"
          exit 1
        }
      shell: pwsh

    - name: Copy Translation Server to publish directory
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $serverSource = "grpc_server\dist\BaketaTranslationServer"
        $serverDest = "$publishDir\grpc_server\BaketaTranslationServer"

        Write-Host "ðŸ“¦ Copying BaketaTranslationServer to publish directory..."

        # Create destination directory
        New-Item -ItemType Directory -Path $serverDest -Force | Out-Null

        # Copy entire PyInstaller output
        Copy-Item "$serverSource\*" $serverDest -Recurse -Force

        if (Test-Path "$serverDest\BaketaTranslationServer.exe") {
          Write-Host "âœ… Translation Server copied successfully"
          $totalSize = (Get-ChildItem $serverDest -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "   Total size: $([math]::Round($totalSize, 2)) MB"
        } else {
          Write-Host "âŒ Failed to copy Translation Server!"
          exit 1
        }
      shell: pwsh

    - name: Create .NET package
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $publishDir = "./publish/Baketa-$version"
        $zipName = "Baketa-$version-win-x64.zip"

        # Copy additional files
        Copy-Item "README.md" "$publishDir/" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$publishDir/" -ErrorAction SilentlyContinue

        # Create zip package
        Compress-Archive -Path "$publishDir/*" -DestinationPath "./publish/$zipName" -Force

        $size = [math]::Round((Get-Item "./publish/$zipName").Length / 1MB, 2)
        echo "## .NET Package" >> $env:GITHUB_STEP_SUMMARY
        echo "- Package: $zipName" >> $env:GITHUB_STEP_SUMMARY
        echo "- Size: $size MB" >> $env:GITHUB_STEP_SUMMARY

    - name: Generate release notes
      run: |
        $version = "${{ steps.version.outputs.version }}"

        @"
        ## Baketa $version

        ### Downloads

        | File | Description |
        |------|-------------|
        | ``Baketa-$version-win-x64.zip`` | Main application (Windows x64) |

        ### Installation

        1. Download ``Baketa-$version-win-x64.zip``
        2. Extract to desired location
        3. Run ``Baketa.UI.exe``
        4. On first run, required components will be downloaded automatically from [Model Assets v1](https://github.com/koizumiiiii/Baketa/releases/tag/models-v1)

        ### Auto-Downloaded Components (from models-v1)

        The following components are downloaded automatically on first run:
        - **BaketaTranslationServer.zip** (~50MB) - NLLB-200 translation server
        - **BaketaSuryaOcrServer.zip** (~174MB) - Surya OCR server
        - **surya-detection-onnx.zip** (~31MB) - Detection model (ONNX INT8)
        - **surya-recognition-quantized.zip** (~665MB) - Recognition model (Quantized PyTorch)
        - **nllb-200-distilled-600M-ct2.zip** (~1.1GB) - Translation model

        ### System Requirements

        - Windows 10/11 (x64)
        - Internet connection (for first-time setup)
        - ~4GB disk space (including auto-downloaded components)
        "@ | Out-File -FilePath "release_notes.md" -Encoding utf8

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: "Baketa ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        files: ./publish/Baketa-${{ steps.version.outputs.version }}-win-x64.zip
        prerelease: ${{ steps.version.outputs.is-prerelease == 'true' }}
        make_latest: ${{ steps.version.outputs.is-prerelease == 'false' }}
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
