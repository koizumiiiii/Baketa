# 座標ずれ修正進捗レポート

## 作業概要
- **目的**: ROI画像での座標ずれ修正とアプリケーションクラッシュ解決
- **開始日時**: 2025-08-25
- **現在ステータス**: 進行中

## 問題発見フェーズ

### 1. 初期問題（解決済み）
- **問題**: アプリケーションクラッシュ（DI競合問題）
- **原因**: PaddleOcrModule内でIOcrEngineとPaddleOcrEngineの多重登録
- **解決方法**: 
  - `PaddleOcrModule.cs`でシングルトン登録を削除、ObjectPool<IOcrEngine>のみ使用
  - `PaddleOcrEngine.cs`で自己流シングルトン管理（static tracking）を廃止
- **解決日時**: 2025-08-25 21:20頃
- **検証結果**: ✅ アプリケーション起動成功、多重インスタンス警告なし

### 2. OCR動作停止問題（✅ 解決済み）
- **問題**: OCR初期化でアプリケーションがハング
- **原因**: `LocalFullModels.ChineseV5`プロパティアクセス時の初期化停止
- **発生箇所**: `PaddleOcrEngine.PrepareModelsAsync`メソッド
- **UltraThink解決策**: 
  - **段階的検証戦略**: EnglishV3 → V4シリーズの安全フォールバック実装
  - **問題箇所修正**: ChineseV5を回避し、安定したV4モデル群を使用
  - **双方向修正**: `PaddleOcrEngine.cs`と`HybridPaddleOcrService.cs`の両方を修正
- **検証結果**: 
  - アプリケーション正常起動（21:40:38時点確認）
  - OCR初期化時間: 3ms（以前は無応答）
  - PooledOcrService、CachedOcrEngine正常動作
- **現在ステータス**: ✅ **根本解決完了**

## 現在の課題（🧠 UltraThink + Gemini分析済み）

### 3. 【緊急】OCR実行時エラー群
- **問題A**: `IImage type WindowsImageAdapter is not supported for caching`
  - **根本原因**: `WindowsImageAdapter: IAdvancedImage`実装 vs `CachedOcrEngine`の`IWindowsImage`型チェック
  - **修正方針**: 型システム継承関係の整合性確保
  
- **問題B**: PaddleOCR predictor連続失敗（3回）によるOCR完全無効化
  - **根本原因**: UltraThink段階的検証後もpredictor内部動作不安定
  - **Gemini推奨**: 
    1. `Mat`オブジェクト防御的コピー (`mat.Clone()`)
    2. 例外具体化と内部例外保持
    3. 診断情報自動保存機能
  - **優先修正**: `PaddleOcrEngine.cs`のMat処理から着手

- **現在ステータス**: 🔥 **緊急修正中** - OCR機能完全停止のため座標ずれ調査不可

### 4. 座標ずれ問題（OCR復旧後に検証）
- **問題**: ROI画像でのテキスト検出座標とアノテーション座標の不一致
- **ユーザー報告**: "位置がずれてるけどなぜ？"
- **予想原因**: 
  - タイルベース処理時の座標オフセット適用不備
  - OCR座標系と画像座標系の変換ミス
- **現在ステータス**: ⏸️ OCR機能復旧待ち

### 5. 分割画像生成問題
- **問題**: 不要な分割画像が生成される
- **ユーザー報告**: "分割もされてますね まあそれはいい"
- **予想原因**: `SaveProcessedImages`設定の読み込み問題
- **現在ステータス**: 🔄 未調査

## 技術的発見事項

### DI競合問題の根本原因
- **競合内容**: 
  - `ObjectPool<IOcrEngine>`システム
  - `AddSingleton<IOcrEngine>()`登録
  - `AddSingleton<PaddleOcrEngine>()`登録
- **問題**: 3つの異なるライフサイクル管理が同時に動作
- **解決アプローチ**: ObjectPool単一化による統一管理

### OCRハング問題の技術詳細
- **ハング箇所**: `Sdcb.PaddleOCR.Models.Local.LocalFullModels.ChineseV5`
- **using宣言**: 正常（`using Sdcb.PaddleOCR.Models.Local;`）
- **可能性**: 
  1. モデルファイル不在による初期化失敗
  2. 静的プロパティ初期化でのデッドロック
  3. PaddleOCRライブラリ内部問題

## 作業計画

### Phase 1: OCR機能復旧（優先度：高）
- [ ] `LocalFullModels.ChineseV5`ハング問題の根本解決
- [ ] モデルファイル存在確認と修復
- [ ] 代替モデル初期化方法の検討

### Phase 2: 座標ずれ修正（優先度：高）
- [ ] OCR復旧後の座標ずれ再現確認
- [ ] タイルオフセット計算ロジック検証
- [ ] 座標変換処理の修正

### Phase 3: 分割画像生成抑制（優先度：中）
- [ ] 設定読み込み処理の調査
- [ ] `SaveProcessedImages`フラグの動作確認
- [ ] 不要な画像生成の抑制

### Phase 4: 最終検証（優先度：中）
- [ ] 全機能統合テスト
- [ ] ユーザー受け入れテスト
- [ ] 性能測定

## リスクと制約

### 技術リスク
- **OCRライブラリ依存**: PaddleOCRライブラリの内部動作に依存
- **モデルファイル**: 大容量モデルファイルの管理・配布
- **プラットフォーム**: Windows固有の実装による移植性の制約

### 時間的制約
- **一時回避策**: OCR機能停止による機能制限
- **ユーザー影響**: ROI画像機能の部分的な動作不良

## 今後のアクション

### 即時対応項目
1. **OCRハング問題調査**: 
   - モデルファイルの実体確認
   - PaddleOCRライブラリのバージョン確認
   - 代替初期化方法の検討

### 中長期対応項目
1. **アーキテクチャ改善**:
   - OCR初期化の非同期化改善
   - エラーハンドリングの強化
   - 設定管理の統一化

## 関連ファイル

### 修正済み
- `Baketa.Infrastructure/DI/PaddleOcrModule.cs`
- `Baketa.Infrastructure/OCR/PaddleOCR/Engine/PaddleOcrEngine.cs`
- `Baketa.Infrastructure/OCR/PaddleOCR/Factory/PaddleOcrEngineFactory.cs`

### 調査対象
- `Baketa.Infrastructure/OCR/BatchProcessing/BatchOcrProcessor.cs`
- `Baketa.Core/Settings/RoiDiagnosticsSettings.cs`
- `Baketa.Infrastructure/OCR/PaddleOCR/Models/`

## ログ・証跡

### 成功ログ例
```
✅ PaddleOcrService: リソース解放完了
🔧 [DI_FIX] IOcrEngine/PaddleOcrEngineシングルトン登録をObjectPoolに統一
```

### 問題ログ例
```
LocalFullModels直接使用による高精度モデル読み込み - 言語: jpn
[以降無応答]
```

---
**更新履歴**:
- 2025-08-25 21:30: 初回作成、DI競合問題解決を記録
- 2025-08-25 21:35: OCRハング問題と一時回避策を追記