using System.Drawing;
using System.IO;
using Microsoft.Extensions.Logging;
using Baketa.Core.Abstractions.Platform.Windows;
using Baketa.Core.Abstractions.Memory;

namespace Baketa.Infrastructure.Platform.Adapters;

/// <summary>
/// IImage â†’ IWindowsImage ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
///
/// ğŸ¯ UltraThink Phase 77.6 å®Œå…¨è§£æ±ºç­–
///
/// å•é¡Œ: ReferencedSafeImage ãŒ IWindowsImage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¦ã„ãªã„
/// è§£æ±º: ReferencedSafeImage ã‚’ IWindowsImage ã¨ã—ã¦æ‰±ãˆã‚‹è»½é‡ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
///
/// æ©Ÿèƒ½:
/// - ReferencedSafeImage â†’ IWindowsImage å‹å¤‰æ›
/// - Bitmap å¤‰æ›ã«ã‚ˆã‚‹ GetBitmap() ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
/// - ROI æ¤œå‡ºå™¨ãŒè¦æ±‚ã™ã‚‹ IWindowsImage äº’æ›æ€§æä¾›
/// </summary>
public sealed class ImageToWindowsImageAdapter : IWindowsImage, IDisposable
{
    private readonly IImage _underlyingImage;
    private readonly ILogger<ImageToWindowsImageAdapter> _logger;
    private Bitmap? _cachedBitmap;
    private bool _disposed;

    /// <summary>
    /// IImage ã® Width ã‚’ IWindowsImage ã¨ã—ã¦å…¬é–‹
    /// </summary>
    public int Width => _underlyingImage.Width;

    /// <summary>
    /// IImage ã® Height ã‚’ IWindowsImage ã¨ã—ã¦å…¬é–‹
    /// </summary>
    public int Height => _underlyingImage.Height;

    /// <summary>
    /// IImage ã® PixelFormat ã‚’ ImagePixelFormat ã¨ã—ã¦å…¬é–‹
    /// </summary>
    public Core.Abstractions.Imaging.ImagePixelFormat PixelFormat => _underlyingImage.PixelFormat;

    /// <summary>
    /// IImage ã® Format ã‚’ IWindowsImage å½¢å¼ã§å…¬é–‹
    /// </summary>
    public Core.Abstractions.Imaging.ImageFormat Format => _underlyingImage.Format;

    /// <summary>
    /// IImage ã® CreatedAt ã‚’å…¬é–‹
    /// </summary>
    public DateTime CreatedAt => _underlyingImage.CreatedAt;

    /// <summary>
    /// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    /// </summary>
    /// <param name="underlyingImage">å¤‰æ›å…ƒã® IImage</param>
    /// <param name="logger">ãƒ­ã‚°å‡ºåŠ›ç”¨</param>
    public ImageToWindowsImageAdapter(
        IImage underlyingImage,
        ILogger<ImageToWindowsImageAdapter>? logger = null)
    {
        _underlyingImage = underlyingImage ?? throw new ArgumentNullException(nameof(underlyingImage));
        _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<ImageToWindowsImageAdapter>.Instance;

        _logger.LogDebug("ğŸ”„ [PHASE77.6] ImageToWindowsImageAdapter ä½œæˆ - Size: {Width}x{Height}, Type: {ImageType}",
            Width, Height, underlyingImage.GetType().Name);
    }

    /// <summary>
    /// IWindowsImage ã¨ã—ã¦è¦æ±‚ã•ã‚Œã‚‹ GetBitmap() ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
    /// </summary>
    /// <returns>System.Drawing.Bitmap</returns>
    public Bitmap GetBitmap()
    {
        ObjectDisposedException.ThrowIf(_disposed, this);

        if (_cachedBitmap != null)
        {
            _logger.LogDebug("ğŸ”„ [PHASE77.6] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ Bitmap ã‚’è¿”å´");
            return _cachedBitmap;
        }

        try
        {
            _logger.LogDebug("ğŸ”„ [PHASE77.6] IImage â†’ Bitmap å¤‰æ›é–‹å§‹");

            // IImage.ToByteArrayAsync() ã‚’åŒæœŸçš„ã«å‘¼ã³å‡ºã—
            var imageBytes = _underlyingImage.ToByteArrayAsync().Result;

            using var memoryStream = new MemoryStream(imageBytes);
            _cachedBitmap = new Bitmap(memoryStream);

            _logger.LogDebug("âœ… [PHASE77.6] Bitmap å¤‰æ›æˆåŠŸ - Size: {Width}x{Height}",
                _cachedBitmap.Width, _cachedBitmap.Height);

            return _cachedBitmap;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "âŒ [PHASE77.6] IImage â†’ Bitmap å¤‰æ›å¤±æ•—: {ErrorMessage}", ex.Message);
            throw new InvalidOperationException($"Failed to convert IImage to Bitmap: {ex.Message}", ex);
        }
    }

    /// <summary>
    /// IImage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã® ToByteArrayAsync() ã‚’å§”è­²
    /// </summary>
    public Task<byte[]> ToByteArrayAsync() => _underlyingImage.ToByteArrayAsync();

    /// <summary>
    /// IImage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã® GetImageMemory() ã‚’å§”è­²
    /// </summary>
    public ReadOnlyMemory<byte> GetImageMemory() => _underlyingImage.GetImageMemory();

    /// <summary>
    /// IImage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã® Clone() ã‚’å§”è­²
    /// </summary>
    public IImage Clone() => _underlyingImage.Clone();

    /// <summary>
    /// IImage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã® ResizeAsync() ã‚’å§”è­²
    /// </summary>
    public Task<IImage> ResizeAsync(int width, int height) => _underlyingImage.ResizeAsync(width, height);

    /// <summary>
    /// ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
    /// </summary>
    public void Dispose()
    {
        if (_disposed) return;

        try
        {
            _cachedBitmap?.Dispose();
            _cachedBitmap = null;

            _logger.LogDebug("ğŸ”„ [PHASE77.6] ImageToWindowsImageAdapter ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾å®Œäº†");
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "âš ï¸ [PHASE77.6] ImageToWindowsImageAdapter ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ã§è­¦å‘Š: {ErrorMessage}", ex.Message);
        }
        finally
        {
            _disposed = true;
        }
    }

    /// <summary>
    /// å†…éƒ¨ã® IImage ã¸ã®å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹
    /// </summary>
    /// <returns>ãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ IImage ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</returns>
    public IImage GetUnderlyingImage()
    {
        ObjectDisposedException.ThrowIf(_disposed, this);
        return _underlyingImage;
    }

    /// <summary>
    /// ãƒ‡ãƒãƒƒã‚°ç”¨ã®æ–‡å­—åˆ—è¡¨ç¾
    /// </summary>
    public override string ToString()
    {
        return $"ImageToWindowsImageAdapter[{Width}x{Height}, Type: {_underlyingImage.GetType().Name}, Disposed: {_disposed}]";
    }
}