<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Baketa.UI.ViewModels.Settings"
             xmlns:controls="using:Baketa.UI.Controls"
             xmlns:converters="using:Baketa.UI.Converters"
             xmlns:local="using:Baketa.UI.Extensions"
             x:Class="Baketa.UI.Views.Settings.LicenseInfoView"
             x:DataType="vm:LicenseInfoViewModel">

    <Design.PreviewWith>
        <Border Padding="20" Width="600" Height="800">
            <!-- Design time preview -->
        </Border>
    </Design.PreviewWith>

        <StackPanel Margin="20,20,20,40" Spacing="20">
            <!-- Header -->
            <StackPanel Spacing="8">
                <TextBlock Text="{local:Localize Settings_License_Title}" FontSize="20" FontWeight="Medium"/>
                <TextBlock Text="{local:Localize Settings_License_Subtitle}"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
            </StackPanel>

            <!-- Loading Indicator -->
            <Border IsVisible="{Binding IsLoading}"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="8" HorizontalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="200"/>
                    <TextBlock Text="{local:Localize Settings_License_Loading}" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- Status Message -->
            <Border IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                    Padding="12,8"
                    CornerRadius="6"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                <TextBlock Text="{Binding StatusMessage}"
                           TextWrapping="Wrap"/>
            </Border>

            <!-- Current Plan Card -->
            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- Plan Details -->
                    <StackPanel Grid.Column="0" VerticalAlignment="Center" Spacing="4">
                        <TextBlock Text="{Binding PlanDisplayName}"
                                   FontSize="18"
                                   FontWeight="Medium"/>
                        <TextBlock Text="{Binding PlanDescription}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <!-- Plan Badge -->
                    <Border Grid.Column="1"
                            Background="{DynamicResource AccentFillColorDefaultBrush}"
                            CornerRadius="4"
                            Padding="12,6"
                            VerticalAlignment="Top">
                        <TextBlock Text="{Binding PlanDisplayName}"
                                   FontSize="12"
                                   FontWeight="Medium"
                                   Foreground="White"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Token Usage Section (Only for Pro/Premium/Ultimate) -->
            <!-- [Issue #296] クォータ超過時もゲージを表示するためHasPaidPlanを使用 -->
            <StackPanel IsVisible="{Binding HasPaidPlan}" Spacing="12">
                <TextBlock Text="{local:Localize Settings_License_TokenUsage}" FontSize="16" FontWeight="Medium"/>

                <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                    <StackPanel Spacing="12">
                        <!-- [Issue #307] Combined Token Usage Gauge (Plan + Bonus) -->
                        <StackPanel Spacing="4">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0"
                                           Text="{local:Localize Settings_License_MonthlyUsage}"
                                           FontSize="12"/>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding CombinedTokenUsageDisplay}"
                                           FontSize="12"
                                           FontWeight="Medium"/>
                            </Grid>

                            <!-- 3セグメントゲージ: 使用済み(青) | プラン残(グレー) | ボーナス(緑) -->
                            <Grid x:Name="GaugeContainer" Height="8" ClipToBounds="True">
                                <!-- 背景（ボーナス部分: 緑） -->
                                <Border Background="#28A745" CornerRadius="4"
                                        IsVisible="{Binding HasBonusTokens}"/>
                                <Border Background="#E9ECEF" CornerRadius="4"
                                        IsVisible="{Binding !HasBonusTokens}"/>

                                <!-- プラン枠全体（グレー、左寄せ） -->
                                <Border Background="#ADB5BD"
                                        HorizontalAlignment="Left"
                                        CornerRadius="4,0,0,4"
                                        IsVisible="{Binding HasBonusTokens}">
                                    <Border.Width>
                                        <MultiBinding Converter="{x:Static converters:PercentToWidthConverter.Instance}">
                                            <Binding Path="Bounds.Width" ElementName="GaugeContainer"/>
                                            <Binding Path="PlanPortionPercentage"/>
                                        </MultiBinding>
                                    </Border.Width>
                                </Border>

                                <!-- 使用済み部分（青、左寄せ） -->
                                <Border Background="{Binding UsageGaugeBrush}"
                                        HorizontalAlignment="Left"
                                        CornerRadius="4,0,0,4">
                                    <Border.Width>
                                        <MultiBinding Converter="{x:Static converters:PercentToWidthConverter.Instance}">
                                            <Binding Path="Bounds.Width" ElementName="GaugeContainer"/>
                                            <Binding Path="UsedPercentageOfTotal"/>
                                        </MultiBinding>
                                    </Border.Width>
                                </Border>
                            </Grid>

                            <!-- ゲージ凡例（ボーナストークンがある場合のみ表示） -->
                            <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,4,0,0"
                                        IsVisible="{Binding HasBonusTokens}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Border Width="12" Height="12" CornerRadius="2" Background="{Binding UsageGaugeBrush}"/>
                                    <TextBlock Text="使用済み" FontSize="10" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Border Width="12" Height="12" CornerRadius="2" Background="#ADB5BD"/>
                                    <TextBlock Text="プラン残" FontSize="10" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Border Width="12" Height="12" CornerRadius="2" Background="#28A745"/>
                                    <TextBlock Text="ボーナス" FontSize="10" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>

                        <!-- Quota Warning -->
                        <Border IsVisible="{Binding IsQuotaExceeded}"
                                Background="{DynamicResource SystemFillColorCriticalBackgroundBrush}"
                                CornerRadius="6"
                                Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"
                                          Width="16" Height="16"
                                          Foreground="{DynamicResource SystemFillColorCriticalBrush}"/>
                                <TextBlock Text="{local:Localize Settings_License_QuotaExceeded}"
                                           Foreground="{DynamicResource SystemFillColorCriticalBrush}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Local Only Message (For Free plan) -->
            <!-- [Issue #296] HasPaidPlanと対になる条件 -->
            <Border IsVisible="{Binding !HasPaidPlan}"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="12" HorizontalAlignment="Center">
                    <PathIcon Data="M12,3A9,9 0 0,0 3,12H0L4,16L8,12H5A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19C10.5,19 9.09,18.5 7.94,17.7L6.5,19.14C8.04,20.3 9.94,21 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M14,12A2,2 0 0,0 12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12Z"
                              Width="32" Height="32"
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                    <TextBlock Text="{local:Localize Settings_License_LocalOnlyMessage}"
                               FontSize="14"
                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               MaxWidth="400"/>
                </StackPanel>
            </Border>

            <!-- Plan Details Section -->
            <StackPanel Spacing="12">
                <TextBlock Text="{local:Localize Settings_License_PlanDetails}" FontSize="16" FontWeight="Medium"/>

                <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                    <StackPanel Spacing="12">
                        <!-- Expiration Date -->
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{local:Localize Settings_License_ExpirationDate}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding ExpirationDateDisplay}"
                                       FontWeight="Medium"
                                       VerticalAlignment="Center"/>
                        </Grid>

                        <!-- Cloud Access -->
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{local:Localize Settings_License_CloudAccess}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding CloudAccessDisplay}"
                                       FontWeight="Medium"
                                       VerticalAlignment="Center"/>
                        </Grid>

                        <!-- Token Limit (for Pro/Premium/Ultimate) -->
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding HasPaidPlan}">
                            <TextBlock Grid.Column="0"
                                       Text="{local:Localize Settings_License_MonthlyLimit}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding TokenLimit, StringFormat='{}{0:N0}'}"
                                       FontWeight="Medium"
                                       VerticalAlignment="Center"/>
                        </Grid>

                        <!-- [Issue #307] Bonus Tokens (if available) -->
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding HasBonusTokens}">
                            <TextBlock Grid.Column="0"
                                       Text="ボーナストークン"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding BonusTokensRemaining, StringFormat='{}{0:N0}'}"
                                       FontWeight="Medium"
                                       Foreground="#28A745"
                                       VerticalAlignment="Center"/>
                        </Grid>

                        <!-- [Issue #307] Total Token Pool (if has bonus) -->
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding HasBonusTokens}">
                            <TextBlock Grid.Column="0"
                                       Text="合計利用可能"
                                       VerticalAlignment="Center"
                                       FontWeight="Medium"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding TotalTokenPool, StringFormat='{}{0:N0}'}"
                                       FontWeight="Bold"
                                       VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Action Buttons -->
            <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Left">
                <Button Content="{local:Localize Settings_License_Refresh}"
                        Command="{Binding RefreshCommand}"
                        Padding="16,8"/>
                <Button Content="{local:Localize Settings_License_Upgrade}"
                        Command="{Binding ChangePlanCommand}"
                        Padding="16,8"
                        Classes="accent"/>
            </StackPanel>

            <!-- Issue #237 Phase 2: プロモーションコードセクション -->
            <StackPanel Spacing="12">
                <TextBlock Text="{local:Localize Settings_License_PromotionCode}" FontSize="16" FontWeight="Medium"/>

                <!-- アクティブなプロモーション表示 -->
                <Border IsVisible="{Binding HasActivePromotion}"
                        Background="{DynamicResource SystemFillColorSuccessBackgroundBrush}"
                        CornerRadius="8"
                        Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource SystemFillColorSuccessBrush}"/>
                            <TextBlock Text="{Binding PromotionAppliedMessage}"
                                       FontWeight="Medium"
                                       Foreground="{DynamicResource SystemFillColorSuccessBrush}"/>
                        </StackPanel>
                        <!-- プロモーションコード表示 -->
                        <StackPanel Orientation="Horizontal" Spacing="4" Margin="24,0,0,0">
                            <TextBlock Text="{local:Localize Settings_License_PromotionCodeLabel}"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding PromotionCodeDisplay}"
                                       FontSize="12"
                                       FontWeight="Medium"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="4" Margin="24,0,0,0">
                            <TextBlock Text="{local:Localize Settings_License_PromotionExpires}"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding PromotionExpiresDisplay}"
                                       FontSize="12"
                                       FontWeight="Medium"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- プロモーションコード入力 -->
                <Border IsVisible="{Binding !HasActivePromotion}"
                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="{local:Localize Settings_License_PromotionCodeDescription}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                   TextWrapping="Wrap"/>

                        <!-- コード入力 -->
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding PromotionCode}"
                                     Watermark="BAKETA-XXXXXXXX"
                                     IsEnabled="{Binding !IsApplyingPromotion}"
                                     Margin="0,0,8,0"/>
                            <Button Grid.Column="1"
                                    Content="{local:Localize Settings_License_PromotionApply}"
                                    Command="{Binding ApplyPromotionCommand}"
                                    IsEnabled="{Binding !IsApplyingPromotion}"
                                    Padding="16,8"
                                    Classes="accent"/>
                        </Grid>

                        <!-- ローディングインジケータ -->
                        <StackPanel IsVisible="{Binding IsApplyingPromotion}"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    HorizontalAlignment="Center">
                            <ProgressBar IsIndeterminate="True" Width="100" Height="4"/>
                            <TextBlock Text="{local:Localize Settings_License_PromotionVerifying}" FontSize="12"/>
                        </StackPanel>

                        <!-- ステータスメッセージ -->
                        <Border IsVisible="{Binding PromotionStatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                Padding="12,8"
                                CornerRadius="6"
                                Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}">
                            <TextBlock Text="{Binding PromotionStatusMessage}"
                                       TextWrapping="Wrap"
                                       FontSize="12"/>
                        </Border>
                    </StackPanel>
                </Border>
            </StackPanel>
        </StackPanel>
</UserControl>
