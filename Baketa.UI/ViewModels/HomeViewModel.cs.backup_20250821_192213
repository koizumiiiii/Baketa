using System;
using System.Collections.ObjectModel;
using System.Reactive;
using System.Threading.Tasks;
using Baketa.UI.Framework;
using Baketa.Core.Abstractions.Events;
using Baketa.UI.Framework.Events;
using Baketa.UI.Framework.ReactiveUI;
using Baketa.UI.Models;
using Baketa.UI.Views;
using Microsoft.Extensions.Logging;
using ReactiveUI;

namespace Baketa.UI.ViewModels;

    /// <summary>
    /// ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ãƒ«
    /// </summary>
    public sealed class HomeViewModel : Framework.ViewModelBase
    {
        // å±¥æ­´ç¢ºèªç”¨
        private bool _hasHistory = true; // ãƒ‡ãƒ¢ç”¨ã«åˆæœŸå€¤ã‚’trueã«è¨­å®š
        public bool HasHistory
        {
            get => _hasHistory;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _hasHistory, value);
        }
        
        // æœ€è¿‘ã®å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
        private ObservableCollection<TranslationHistoryItem> _recentHistoryItems = [];
        public ObservableCollection<TranslationHistoryItem> RecentHistoryItems
        {
            get => _recentHistoryItems;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _recentHistoryItems, value);
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
        private string _welcomeMessage = "Baketaã¸ã‚ˆã†ã“ã";
        public string WelcomeMessage
        {
            get => _welcomeMessage;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _welcomeMessage, value);
        }
        
        private string _statusMessage = "æº–å‚™å®Œäº†";
        public string StatusMessage
        {
            get => _statusMessage;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _statusMessage, value);
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦æƒ…å ±
        private string _appDescription = "Baketaã¯ã€ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¿»è¨³ã™ã‚‹Windowså°‚ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚";
        public string AppDescription
        {
            get => _appDescription;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _appDescription, value);
        }
        
        // ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        private string _captureStatus = "åœæ­¢ä¸­";
        public string CaptureStatus
        {
            get => _captureStatus;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _captureStatus, value);
        }
        
        // ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²
        private string _captureStatusColor = "#757575"; // åˆæœŸå€¤ã¯åœæ­¢ä¸­ã®è‰²
        public string CaptureStatusColor
        {
            get => _captureStatusColor;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _captureStatusColor, value);
        }
        
        // ç¿»è¨³ã‚¨ãƒ³ã‚¸ãƒ³
        private string _translationEngine = "Google";
        public string TranslationEngine
        {
            get => _translationEngine;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _translationEngine, value);
        }
        
        // ç¿»è¨³å…ˆè¨€èª
        private string _targetLanguage = "è‹±èª";
        public string TargetLanguage
        {
            get => _targetLanguage;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _targetLanguage, value);
        }
        
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
        private string _memoryUsage = "45.8";
        public string MemoryUsage
        {
            get => _memoryUsage;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _memoryUsage, value);
        }
        
        // å®Ÿè¡Œæ™‚é–“
        private string _runningTime = "0æ™‚é–“ 25åˆ†";
        public string RunningTime
        {
            get => _runningTime;
            set => ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged(this, ref _runningTime, value);
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒãƒ³ãƒ‰
        public ReactiveCommand<Unit, Unit> StartCaptureCommand { get; }
        public ReactiveCommand<Unit, Unit> OpenSettingsCommand { get; }
        public ReactiveCommand<Unit, Unit> OpenCaptureSettingsCommand { get; }
        public ReactiveCommand<Unit, Unit> OpenTranslationSettingsCommand { get; }
        public ReactiveCommand<Unit, Unit> OpenHelpCommand { get; }
        public ReactiveCommand<Unit, Unit> ViewAllHistoryCommand { get; }
        
        /// <summary>
        /// æ–°ã—ã„HomeViewModelã‚’åˆæœŸåŒ–ã—ã¾ã™
        /// </summary>
        /// <param name="eventAggregator">ã‚¤ãƒ™ãƒ³ãƒˆé›†ç´„å™¨</param>
        /// <param name="logger">ãƒ­ã‚¬ãƒ¼</param>
        public HomeViewModel(IEventAggregator eventAggregator, ILogger? logger = null)
            : base(eventAggregator, logger)
        {
            // ã‚³ãƒãƒ³ãƒ‰ã®åˆæœŸåŒ–
            StartCaptureCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteStartCaptureAsync);
            OpenSettingsCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteOpenSettingsAsync);
            OpenCaptureSettingsCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteOpenCaptureSettingsAsync);
            OpenTranslationSettingsCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteOpenTranslationSettingsAsync);
            OpenHelpCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteOpenHelpAsync);
            ViewAllHistoryCommand = Framework.ReactiveUI.ReactiveCommandFactory.Create(ExecuteViewAllHistoryAsync);
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            InitializeDemo();
        }
        
        /// <summary>
        /// ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®å‡¦ç†
        /// </summary>
        protected override void HandleActivation()
        {
            // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
            SubscribeToEvent<CaptureStatusChangedEvent>(OnCaptureStatusChanged);
            SubscribeToEvent<TranslationSettingsChangedEvent>(OnTranslationSettingsChanged);
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        private void InitializeDemo()
        {
            // å±¥æ­´ã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
            if (_recentHistoryItems.Count == 0)
            {
                _recentHistoryItems.Add(new TranslationHistoryItem
                {
                    Id = Guid.NewGuid().ToString(),
                    SourceText = "å†’é™ºã®æ—…ã«å‡ºã‹ã‘ã‚ˆã†",
                    TranslatedText = "Let's go on an adventure",
                    SourceLanguage = "Japanese",
                    TargetLanguage = "English",
                    Engine = "Google",
                    Timestamp = DateTime.Now.AddMinutes(-5)
                });
                
                _recentHistoryItems.Add(new TranslationHistoryItem
                {
                    Id = Guid.NewGuid().ToString(),
                    SourceText = "è¬ã®å¤ä»£éºè·¡ã‚’ç™ºè¦‹ã—ãŸ",
                    TranslatedText = "Found a mysterious ancient ruin",
                    SourceLanguage = "Japanese",
                    TargetLanguage = "English",
                    Engine = "Google",
                    Timestamp = DateTime.Now.AddMinutes(-15)
                });
                
                _recentHistoryItems.Add(new TranslationHistoryItem
                {
                    Id = Guid.NewGuid().ToString(),
                    SourceText = "å‹‡è€…ã®å‰£ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼",
                    TranslatedText = "Obtained the hero's sword!",
                    SourceLanguage = "Japanese",
                    TargetLanguage = "English",
                    Engine = "Google",
                    Timestamp = DateTime.Now.AddMinutes(-25)
                });
            }
        }
        
        // ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteStartCaptureAsync()
        {
            //_logger?.LogInformation("ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            
            try
            {
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç›´æ¥è¡¨ç¤ºï¼ˆMainOverlayViewModelã¨åŒã˜ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
                var dialogViewModel = new WindowSelectionDialogViewModel(EventAggregator, null!, null!);
                var dialog = new WindowSelectionDialogView
                {
                    DataContext = dialogViewModel
                };

                // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å–å¾—
                var mainWindow = Avalonia.Application.Current?.ApplicationLifetime is Avalonia.Controls.ApplicationLifetimes.IClassicDesktopStyleApplicationLifetime desktop
                    ? desktop.MainWindow
                    : null;

                if (mainWindow != null)
                {
                    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦çµæœã‚’å¾…æ©Ÿ
                    await dialog.ShowDialog(mainWindow).ConfigureAwait(false);
                    var selectedWindow = dialogViewModel.DialogResult;
                    
                    if (selectedWindow != null)
                    {
                        // ç¿»è¨³é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œï¼ˆãƒ­ã‚°è¿½åŠ ï¼‰
                        try
                        {
                            System.IO.File.AppendAllText("E:\\dev\\Baketa\\debug_app_logs.txt", 
                                $"{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff} ğŸ¯ [DIRECT] HomeViewModel - StartTranslationRequestEventç™ºè¡Œé–‹å§‹: {selectedWindow.Title}{Environment.NewLine}");
                        }
                        catch (Exception fileEx)
                        {
                            System.Diagnostics.Debug.WriteLine($"HomeViewModel ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: {fileEx.Message}");
                        }
                        
                        await PublishEventAsync(new StartTranslationRequestEvent(selectedWindow)).ConfigureAwait(false);
                        
                        try
                        {
                            System.IO.File.AppendAllText("E:\\dev\\Baketa\\debug_app_logs.txt", 
                                $"{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff} ğŸ¯ [DIRECT] HomeViewModel - StartTranslationRequestEventç™ºè¡Œå®Œäº†: {selectedWindow.Title}{Environment.NewLine}");
                        }
                        catch (Exception fileEx)
                        {
                            System.Diagnostics.Debug.WriteLine($"HomeViewModel ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: {fileEx.Message}");
                        }
                    }
                }
            }
            catch (Exception)
            {
                // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆ_loggerãŒnullã®å ´åˆã‚‚ã‚ã‚‹ãŸã‚ã€æ¡ä»¶ä»˜ãï¼‰
                //_logger?.LogError(ex, "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }
        
        // è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteOpenSettingsAsync()
        {
            //_logger?.LogInformation("è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            // è¨­å®šç”»é¢ã‚’é–‹ããƒ­ã‚¸ãƒƒã‚¯ï¼ˆã¾ã æœªå®Ÿè£…ï¼‰
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // ã‚­ãƒ£ãƒ—ãƒãƒ£è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteOpenCaptureSettingsAsync()
        {
            //_logger?.LogInformation("ã‚­ãƒ£ãƒ—ãƒãƒ£è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            await PublishEventAsync(new OpenCaptureSettingsRequestedEvent()).ConfigureAwait(false);
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // ç¿»è¨³è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteOpenTranslationSettingsAsync()
        {
            //_logger?.LogInformation("ç¿»è¨³è¨­å®šç”»é¢ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            await PublishEventAsync(new OpenTranslationSettingsRequestedEvent()).ConfigureAwait(false);
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // ãƒ˜ãƒ«ãƒ—ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteOpenHelpAsync()
        {
            //_logger?.LogInformation("ãƒ˜ãƒ«ãƒ—ã‚’é–‹ãã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            // ãƒ˜ãƒ«ãƒ—ç”»é¢ã‚’é–‹ããƒ­ã‚¸ãƒƒã‚¯ï¼ˆã¾ã æœªå®Ÿè£…ï¼‰
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // å…¨å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        private async Task ExecuteViewAllHistoryAsync()
        {
            //_logger?.LogInformation("å…¨å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
            await PublishEventAsync(new OpenHistoryViewRequestedEvent()).ConfigureAwait(false);
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        private async Task OnCaptureStatusChanged(CaptureStatusChangedEvent eventData)
        {
            if (eventData.IsActive)
            {
                StatusMessage = "ã‚­ãƒ£ãƒ—ãƒãƒ£ä¸­";
                CaptureStatus = "ã‚­ãƒ£ãƒ—ãƒãƒ£ä¸­";
                CaptureStatusColor = "#4CAF50"; // SuccessColor
            }
            else
            {
                StatusMessage = "æº–å‚™å®Œäº†";
                CaptureStatus = "åœæ­¢ä¸­";
                CaptureStatusColor = "#757575"; // TextSecondaryColor
            }
            await Task.CompletedTask.ConfigureAwait(false);
        }
        
        // ç¿»è¨³è¨­å®šå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        private async Task OnTranslationSettingsChanged(TranslationSettingsChangedEvent eventData)
        {
            TranslationEngine = eventData.Engine;
            TargetLanguage = eventData.TargetLanguage;
            
            await Task.CompletedTask.ConfigureAwait(false);
        }
    }
